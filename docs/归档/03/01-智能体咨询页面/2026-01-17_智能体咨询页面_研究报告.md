# 智能体咨询页面 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始研究报告 | 新建 |
| 2026-01-17 | v1.1 | 补充历史会话入口设计 | 需求补充 |
| 2026-01-17 | v1.2 | 明确 SubLayout 作为页面模板及其定制能力分析 | 结构重构与一致性需求 |
| 2026-01-17 | v1.3 | 修正API接口描述，补充标准接口与调用示例 | 对齐API设计文档 |
| 2026-01-18 | v1.4 | 根据最新 openapi 更新 API 参数和返回结构 | 对齐最新 API 规范 |
| 2026-01-18 | v1.5 | 补充SSE流式协议与异常处理机制细节 | 对齐后端接口细节文档 |

## 研究问题

如何实现“智能体咨询”页面？（含流式输出、历史会话入口、API参数标准化、组件结构、异常处理、SSE协议细节等）



## 发现摘要

- 智能体咨询页面以沉浸式对话为核心，需支持流式消息输出（后端已采用标准SSE协议），引用卡片、快捷操作、一键转人工。
- `/api/consult/chat` 接口采用 `POST`，响应类型为 `text/event-stream`，前端需通过流式拼接实时渲染AI回复。
- 后端异常会以 `[ERROR]` 开头字符串推送，前端需识别并弹窗提示，保障体验。
- 新增“历史会话”入口，便于用户回顾与管理过往咨询（当前仅占位，后续可扩展为会话列表与跳转）。
- 前端需实现消息流（MessageList）、输入区（InputBar）、引用卡（ReferenceCard）、快捷操作条（QuickActions）、历史会话入口（HistoryEntry）等组件，适配移动端优先。
- 历史会话、消息详情、引用卡等均有标准API，需严格按API文档参数与返回结构实现，便于前后端解耦。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|docs/page-designs/智能体咨询-页面设计.md|页面设计规范与交互细节|全篇|
|docs/“心青年”智能体平台-功能文档.md|RAG咨询、工单、RBAC等后端能力说明|全篇|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|API标准定义与数据结构|全篇|
|src/pages/consultation/index.jsx|（假定）智能体咨询页面实现|待补充|
|src/components/MessageList/index.jsx|（假定）消息流组件|待补充|
|src/components/InputBar/index.jsx|（假定）输入区组件|待补充|
|src/components/HistoryEntry/index.jsx|（建议）历史会话入口组件（占位）|待补充|
|src/layouts/SubLayout.jsx|页面通用布局模板，包裹咨询主内容|全篇|

## 当前实现分析



### 1. 页面结构与核心流程（含 SubLayout 应用）


页面整体以 `SubLayout` 组件为顶层包裹，统一页面结构、导航与移动端适配。SubLayout 支持自定义 header、footer、内容区样式等，便于后续扩展和风格统一。

- SubLayout（页面模板）：统一头部、底部、内容区布局，支持 props 定制（如 title、showBack、extraActions、children 等）
  - 顶部 Header：通过 SubLayout 的 header slot 或 props 定制，包含返回、标题、转人工按钮、历史会话入口（占位，点击可跳转历史会话页，后续扩展）
    - 标题 Title：显示`智能体咨询`，副标题为当前会话标题
      - 新建的对话为`新对话`；
      - 在进行第一次对话后，后端返回的流式输出的尾包带有`topic`字段（如`[TOPIC]{json.dumps({'topic': topic})}`），前端更新标题为该字段内容。
    - 右侧有两个操作按钮：历史会话入口（占位，后续实现跳转/弹窗）、转人工（占位，后续跳转工单创建页，附带会话摘要）
- 会话区 MessageList：AI/用户气泡、时间、异常态、自动滚动
- 引用卡 ReferenceCard：AI消息下方，点击弹出详情
  - 引用卡来源于 AI 回复中的 sources 字段，若有引用则渲染引用卡片，点击跳转知识详情页；若无引用则不渲染。
- 快捷操作条 QuickActions：常用模板横向滚动，具体内容参考情境生成。
- 输入区 InputBar：多行自适应、发送、附件/语音（代码中注释提示，暂时不实现）


#### 流程示意（含 SubLayout 包裹）：

```
用户进入页面 →
 1. 页面由 SubLayout 统一包裹，渲染 header（含返回、标题、历史会话入口、转人工等）
 2. 可见“历史会话”入口（占位，点击跳转/弹窗，后续实现）
 3. 用户输入问题 → 发送 →
   a. 前端展示用户气泡
   b. 前端请求后端（建议流式接口）
   c. AI回复流式输出，逐步渲染AI气泡
   d. 若有引用，渲染引用卡
   e. 用户可点击“转人工”，附带会话摘要跳转工单页
```



### 2. 关键API与调用示例（对齐API设计文档）

#### 2.1 会话与消息相关API


#### 2.1 会话与消息相关API（严格按最新 openapi 参数实现）
- 创建新会话
  - `POST /api/consult/sessions`（body: {topic?}，返回 ConsultationSession {topic?, is_archived?, id, user_id, created_at, messages?}）
- 获取历史会话列表
  - `GET /api/consult/sessions`（返回 ConsultationSession[]，支持分页参数 page, size）
- 获取会话消息详情
  - `GET /api/consult/sessions/{session_id}`（返回 ConsultationMessage[]，支持分页参数 page, size）
- 发送消息并获取AI回复
  - `POST /api/consult/chat`（body: {query, role, reasoning_effort?, session_id?}，当前返回 {}，建议支持SSE/WebSocket流式）


#### 2.2 关键前端调用示例（含SSE流式与异常处理）

```js
// 发送消息并获取AI回复（SSE流式输出，异常处理）
const response = await fetch('/api/consult/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ session_id, query, role, reasoning_effort })
});
const reader = response.body.getReader();
let aiMsg = '';
while(true) {
  const { done, value } = await reader.read();
  if (done) break;
  const chunk = new TextDecoder().decode(value);
  if (chunk.startsWith('[ERROR]')) {
    // 异常弹窗提示
    showErrorModal(chunk);
    break;
  }
  aiMsg += chunk;
  setAiMessage(aiMsg); // 实时渲染
}
```

```js
// 获取历史会话列表
const res = await fetch('/api/consult/sessions?page=1&size=20');
const sessions = await res.json(); // sessions: ConsultationSession[]
```

```js
// 获取会话消息详情
const res = await fetch(`/api/consult/sessions/${sessionId}?page=1&size=20`);
const messages = await res.json(); // messages: ConsultationMessage[]
```

```js
// 引用卡点击跳转知识详情
navigate(`/knowledge/${refId}`);
```

```js
// 转人工：跳转工单创建页，附带会话摘要
navigate('/my/tickets/create', { state: { summary: getSummary(messages) } });
```





## 架构洞察

- SubLayout 作为页面模板，统一了页面结构、导航与风格，便于后续维护和风格升级。
- SubLayout 支持灵活的 props 传递（如 title、header slot、extraActions），可满足不同页面的定制需求。
- `/api/consult/chat` 已采用标准SSE协议，前端需通过流式拼接实时渲染AI回复，异常以 `[ERROR]` 字符串推送，需弹窗提示。
- 消息、引用卡、历史会话等结构需标准化，严格按API文档参数与返回结构实现，便于前端渲染与跳转。
- “历史会话”入口建议独立组件，后续可扩展为会话列表、详情页。
- “转人工”需后端支持会话摘要生成，或前端本地生成摘要。
- 需注意移动端输入区与键盘适配、自动滚动。




## 潜在风险和边缘情况

- 后端接口若不支持 `/api/consult/chat` 流式输出（SSE/WebSocket），体验大幅下降。
- SSE流式推送过程中如遇异常，后端会以 `[ERROR]` 字符串推送，前端需及时弹窗提示并中断渲染。
- AI回复持久化失败后端有重试机制（最多2次），最终失败会推送错误信息，前端需兜底。
- session_id 缺失或无效时接口直接返回 401/400（非流式），需前端校验与提示。
- 引用卡数据不全或知识详情404需友好提示。
- 转人工时摘要过长或敏感信息泄露风险。
- 历史会话入口如无数据源，需有占位与友好提示，后续数据结构需与主会话区解耦。
- 前端需严格按API文档参数与返回结构实现，避免字段不一致导致渲染异常。




## 开放问题

- `/api/consult/chat` SSE协议是否支持多种异常类型？前端异常处理是否需区分？   回答：当前仅有统一的 `[ERROR]` 字符串标识异常，前端只需弹窗提示即可，无需区分异常类型。
- 会话摘要生成由前端还是后端负责？摘要字段标准？    回答：刚创建会话时，会话标题是“新对话”，然后，用户发送第一条消息后，后台会根据这条消息内容生成会话标题，前端不需要处理这个逻辑。
- 引用卡与知识详情的数据结构标准？（预留接口和组件，目前不需要实现）（建议严格按API文档）
- 历史会话数据接口、结构、权限如何设计？是否支持分页、检索？

## 参考资料

- docs/page-designs/智能体咨询-页面设计.md
- docs/“心青年”智能体平台-功能文档.md
- docs/“心青年”智能体平台-数据模型与 API 设计.md
- OpenAI ChatGPT流式API、SSE/WebSocket最佳实践

