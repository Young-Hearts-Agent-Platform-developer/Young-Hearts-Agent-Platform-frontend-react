# 智能体咨询页面 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-18 | v1.0 | 初始计划 | 基于 2026-01-17 研究报告与澄清结论 |
| 2026-01-18 | v1.1 | 细化 Phase 1、2，补充页面设计细节 | 参考页面设计文档，增强实现指引 |
| 2026-01-18 | v1.2 | 重构 Phase 3，细化为 3.1/3.2，补充进入 /consultation 自动创建新会话 | 需求澄清与API对齐 |


## 关联研究
[docs/tasks/罗问然/01-智能体咨询页面/2026-01-17_智能体咨询页面_研究报告.md](docs/tasks/罗问然/01-智能体咨询页面/2026-01-17_智能体咨询页面_研究报告.md)

## 功能概述
实现“智能体咨询”页面，支持流式AI对话、历史会话入口与跳转、引用卡片、快捷操作、异常处理等。页面采用 SubLayout 模板，移动端优先，组件库为 Ant Design，图标库优先 antd-mobile-icons。历史会话入口跳转至新建的历史会话占位页面。

---


## Phase 1: 页面骨架与 SubLayout 集成（细化版）

### 目标
- 在 `/consultation` 路由下实现页面骨架，采用 `SubLayout` 包裹，头部参照[页面设计文档](../../page-designs/智能体咨询-页面设计.md)视觉与交互规范：
	- 固定顶部，左侧返回按钮，居中标题“智能体咨询”，右侧依次为历史会话入口、转人工按钮。
	- 历史会话入口与转人工按钮采用相同的圆形图标按钮组件设计，仅用恰当图标表示，无需文字内容，图标分别表达“历史会话/消息记录”与“转人工/客服”语义。
	- 头部高度、间距、配色、按钮样式等需与设计稿一致，移动端优先。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/index.jsx|新增/重构|主页面实现，参考设计稿布局|
|src/layouts/SubLayout.jsx|补充|支持 header/rightActions slot，满足头部定制|
|src/components/IconActionButton/index.jsx|新增|通用圆形图标按钮组件，用于头部操作区|
|src/pages/history-sessions/index.jsx|新增|历史会话占位页面|

### 具体变更
- 新建 `/consultation` 页面，整体用 `SubLayout` 包裹，传递 `title`、`showBack`、`rightActions` 等 props。
- 头部左侧为返回按钮（大圆角、主色 hover 态），点击返回上一页或首页。
- 居中标题“智能体咨询”，后续可动态更新为会话标题。
- 右侧依次为：
	- 历史会话入口与转人工按钮均采用通用圆形图标按钮组件（IconActionButton），仅展示图标，无文字，hover/active 态明显，适配移动端触控反馈。
	- 历史会话入口点击跳转 `/history-sessions` 占位页，图标建议用“消息记录/历史”类（如 Vant 的 chat-o/records/history）。
	- 转人工按钮点击跳转 `/my/tickets/create`，图标建议用“客服/人工”类（如 Vant 的 service-o/headset）。
- `SubLayout` 支持 header/extraActions slot，便于头部灵活扩展。

### 成功标准
- 自动验证：页面可正常渲染，头部按钮跳转无报错。
- 手动验证：
	- 头部布局、样式与[页面设计文档](../../page-designs/智能体咨询-页面设计.md)一致。
	- 历史会话入口与转人工按钮样式一致，仅展示图标，点击后路由跳转正确。


---


## Phase 2: 消息流与输入区基础实现（细化版）

### 目标
- 实现消息流（MessageList）与输入区（InputBar）基础交互，参考[页面设计文档](../../page-designs/智能体咨询-页面设计.md)：
	- 消息流支持 AI/用户气泡、时间、自动滚动。
	- 输入区支持多行自适应、发送按钮，移动端适配。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/components/MessageList/index.jsx|新增|消息流组件，气泡样式与交互参照设计稿|
|src/components/InputBar/index.jsx|新增|输入区组件，支持多行输入与发送|
|src/pages/consultation/index.jsx|补充|集成上述组件，主内容区布局|

### 具体变更
- 新建 `MessageList` 组件：
	- 渲染用户气泡（主色底、右对齐、圆角大）、AI气泡（白底、左对齐、淡蓝边框、阴影），气泡宽度、间距、字体等严格按设计稿。
	- 气泡下方显示时间/元信息，小号灰色文字。
	- 支持自动滚动到底部，移动端滚动流畅。
- 新建 `InputBar` 组件：
	- 固定底部，白底，顶部细分割线，输入框圆角大，主色边框聚焦。
	- 输入框多行自适应（最大4行），发送按钮主色填充，禁用态灰色。
	- 适配移动端键盘弹起，确保输入区与最新消息可见。
- 在 `/consultation` 页面集成上述组件，主内容区高度自适应填充。

### 成功标准
- 自动验证：输入消息后可在消息流中显示。
- 手动验证：
	- 消息流、输入区样式与[页面设计文档](../../page-designs/智能体咨询-页面设计.md)一致。
	- 输入区交互流畅，移动端无遮挡。

---

## Phase 3.1: SSE流式API封装与自动会话创建

### 目标
- 封装 `/api/consult/chat` SSE流式API，完善事件处理。
- 进入 `/consultation` 页面时自动创建新会话（调用 `POST /api/consult/sessions`），并将 session_id 用于后续对话。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|新建|SSE API 封装，新增 createSession 自动调用|
|src/utils/sse.js|新建|SSE 工具完善，支持更健壮的事件处理|
|src/pages/consultation/index.jsx|补充/重构|页面挂载时自动创建会话，集成流式渲染与异常处理|
|docs\tasks\罗问然\01-智能体咨询页面\AI问答及Session记录.md|参考|API参数与返回结构对齐|

### 具体变更
- 封装 chatSSE 方法，支持事件监听、断开、异常处理。
- 工具类支持消息拼接、错误捕获、连接状态管理。
- 进入 `/consultation` 页面时自动调用 createSession，获取 session_id 并存储。
- 支持浏览器默认的SSE重连机制，无需自定义重连。

### 成功标准
- 自动验证：SSE连接可正常建立，事件流可被消费。
- 自动验证：页面挂载后自动创建新会话，session_id 可用于后续对话。
- 手动验证：断网/异常时能捕获并处理。

---

## Phase 3.2: 流式渲染与异常弹窗集成

### 目标
- 在咨询页面集成流式消息渲染，异常弹窗提示。
- AI 回复期间，禁止用户发送内容（发送按钮变为灰色，且禁用）。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/index.jsx|补充/重构|集成SSE渲染与异常处理，自动会话创建逻辑|
|src/components/Toast/|复用|异常弹窗组件|

### 具体变更
- 发送消息后，AI回复流式拼接展示。
- 遇 [ERROR] 时弹窗提示，断开连接。
- 遇 [Topic] 时直接更新页面副标题，无需动画。
- 异常弹窗复用现有 src/components/Toast/ 组件。
- AI 回复期间，禁止用户发送内容（发送按钮变为灰色，且禁用）。

### 成功标准
- 自动验证：AI回复流式渲染，异常弹窗可见。
- 手动验证：断网/异常时弹窗提示，页面副标题可动态更新。

---

## Phase 4: 引用卡与快捷操作条实现

### 目标
- 支持AI回复中的引用卡（ReferenceCard）、快捷操作条（QuickActions）。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/components/ReferenceCard/index.jsx|新增|引用卡组件|
|src/components/QuickActions/index.jsx|新增|快捷操作条组件|
|src/pages/consultation/index.jsx|补充|集成上述组件|

### 具体变更
- AI消息含 sources 字段时渲染引用卡，点击跳转知识详情。
- 快捷操作条横向滚动，支持常用模板。

### 成功标准
- 自动验证：引用卡点击跳转 /knowledge/:id。
- 手动验证：快捷操作条可用。

---

## Phase 5: 历史会话入口与跳转逻辑

### 目标
- 历史会话入口组件实现，跳转至历史会话占位页。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/components/HistoryEntry/index.jsx|补充|跳转逻辑|
|src/pages/history-sessions/index.jsx|新增|历史会话占位页面|
|docs/“心青年”智能体平台-前端界面设计方案.md|补充|补充历史会话页面设计|

### 具体变更
- 历史会话入口点击跳转 /history-sessions。
- 设计文档补充历史会话页面说明。

### 成功标准
- 自动验证：跳转无报错。
- 手动验证：历史会话页面可见。

---

## Phase 6: API 封装与参数/返回结构对齐

### 目标
- 咨询相关API封装，参数与返回结构严格对齐 openapi。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|补充|API方法完善|
|src/pages/consultation/index.jsx|补充|API调用对齐|

### 具体变更
- 封装 createSession、getSessions、getSessionMessages、chat（SSE）等API。

### 成功标准
- 自动验证：API调用无报错，数据结构一致。
- 手动验证：接口联调通过。

---

## Phase 7: 移动端适配与交互优化

### 目标
- 页面与组件适配移动端，输入区不被遮挡，交互流畅。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/styles/consultation.css|新增/补充|移动端样式|
|src/pages/consultation/index.jsx|补充|交互优化|
|src/components/InputBar/index.jsx|补充|键盘适配|

### 具体变更
- 适配 viewport resize，输入区不被遮挡。
- 组件样式移动端友好。

### 成功标准
- 自动验证：移动端浏览无样式错位。
- 手动验证：输入区、消息流交互流畅。

---

## Phase 8: 验证与测试

### 目标
- 全流程自动化与手动测试，确保功能可用。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/index.jsx|补充|单元/集成测试|
|src/components/*|补充|单元测试|

### 具体变更
- 编写基础测试用例，手动走查主流程。

### 成功标准
- 自动验证：测试用例全部通过。
- 手动验证：主流程无阻断bug。

---

## PR提交模板

- feat: 智能体咨询页面及相关组件实现
- 补充历史会话入口与页面设计
- 对齐API参数与流式协议，异常处理完善

---


