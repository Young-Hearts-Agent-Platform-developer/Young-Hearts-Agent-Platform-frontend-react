后端 SSE 流式协议与异常处理细节（供前端对接）：

### 1. 请求方式
- 路径：`POST /api/consult/chat`
- Header：`Content-Type: application/json`
- Body 示例：
  ```json
  {
    "session_id": 123,
    "query": "我最近很焦虑怎么办？",
    "role": "friend",
    "reasoning_effort": "详细分析"
  }
  ```
- 需携带登录凭证（如 Cookie 或 session_id）

### 2. 响应协议
- 响应类型：`text/event-stream`
- 采用标准 SSE 协议，逐步推送 AI 回复内容
- 每次推送为一段字符串（可为完整句子或部分内容），前端需实时拼接渲染

### 3. 前端接收示例
```js
const response = await fetch('/api/consult/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ session_id, query, role, reasoning_effort })
});
const reader = response.body.getReader();
let aiMsg = '';
while(true) {
  const { done, value } = await reader.read();
  if (done) break;
  aiMsg += new TextDecoder().decode(value);
  // 实时渲染
  setAiMessage(aiMsg);
}
```

### 4. 异常处理机制
- 若 AI 生成或流式推送过程中发生异常，后端会推送一条以 `[ERROR]` 开头的字符串，如：
  ```
  [ERROR]AI消息持久化失败: 数据库连接异常
  ```
- 前端收到 `[ERROR]` 字样时，可弹窗提示或特殊处理
- 后端持久化 AI 回复时有重试机制（最多2次），最终失败会推送错误信息

### 5. 其他说明
- SSE流式推送结束后，AI回复会一次性写入数据库，sources 字段预留但当前为 None
- 若 session_id 缺失或无效，接口会返回 401 或 400 错误（非流式）

如需更详细字段或协议样例，可进一步补充。