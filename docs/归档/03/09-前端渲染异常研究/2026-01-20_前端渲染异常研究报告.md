# 前端渲染异常研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-20 | v1.0 | 初始研究报告 | 新建任务 |
| 2026-01-20 | v1.1 | 深入分析换行符丢失与样式问题 | 补充研究 |
| 2026-01-20 | v1.2 | **重大更新**：发现导致空白气泡的致命解析缺陷 | 结合用户截图分析 |

## 研究问题

用户反馈咨询页面出现**空白气泡**，Network 面板显示后端已返回完整字符串响应（如 `你好呀...[TOPIC]...`），但 UI 无法渲染。

## 发现摘要

- **致命缺陷 (Critical)**：`chatSSE` 解析逻辑存在严重漏洞。当后端返回数据**不包含换行符**或**末尾无换行符**时，整个响应会被视为“未完成行”暂存在 `buffer` 中，并在流结束时**被直接丢弃**，导致 `onMessage` 从未触发，造成气泡空白。
- **次要缺陷**：`split` 逻辑移除了文本原本的格式换行；`MessageList` 样式缺少 `white-space: pre-wrap`。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/api/consult.js|流式 API 客户端实现，包含数据分帧与回调|L45-L95|
|src/pages/consultation/chat.jsx|消息状态管理与流式内容拼接|L74-L80|

## 当前实现分析

### 核心异常流程 (Root Cause Analysis - 空白气泡之谜)

1.  **数据接收与缓冲 (`src/api/consult.js`)**
    假设后端返回长字符串：`"DATA_WITHOUT_NEWLINE"`。
    ```javascript
    buffer += decoder.decode(value, { stream: true }); 
    // buffer = "DATA_WITHOUT_NEWLINE"
    let lines = buffer.split(/\r?\n/); 
    // lines = ["DATA_WITHOUT_NEWLINE"]
    buffer = lines.pop(); 
    // buffer = "DATA_WITHOUT_NEWLINE", lines = []
    ```
    此时 `lines` 为空，循环体不执行，`onMessage` 未触发。

2.  **流结束时的静默丢弃**
    ```javascript
    while (true) {
        const { done, value } = await reader.read();
        if (done) break; // <--- 循环直接跳出
        // ...
    }
    // <--- 此处没有任何处理 buffer 剩余内容的代码
    if (!completed && onComplete) onComplete(); 
    ```
    结果：`buffer` 中的 `"DATA_WITHOUT_NEWLINE"` 被彻底遗忘，前端收到空消息。

### 次要问题回顾

- `split` 移除换行符：`"A\nB"` -> `onMessage("A")`, `onMessage("B")` -> 显示结果 `AB`。
- `if (!line.trim()) continue`：丢弃空行，合并段落。

## 解决方案建议

### 1. 修复 buffer 丢失问题 (必须立即执行)

在 `while` 循环结束后（即流关闭时），**强制处理** `buffer` 中残留的内容。

```javascript
// src/api/consult.js

// ... while 循环 ...
while (true) {
  // ... 原有逻辑 ...
}

// [新增修复逻辑] 处理最后残留的 buffer
if (buffer && buffer.trim()) {
  // 复用处理逻辑，或直接回调
  // 注意：需要处理可能的特殊控制包（虽然概率小，因为控制包通常有换行）
  // 简单处理：
  if (onMessage) onMessage(buffer, {});
}

if (!completed && onComplete) onComplete();
```

或者，更加健壮的做法是将处理单行的逻辑提取为函数 `processLine(line)`，并在循环内和循环后分别调用。

### 2. 改进换行符处理

建议修改 `chatSSE`，尽量保留原始换行符，或在拼接时补齐。
同时在 CSS 中添加 `white-space: pre-wrap`。

## 验证计划

1.  **复现**：Mock 后端返回不带换行符的长字符串，确认气泡空白。
2.  **修复**：应用上述逻辑修复 `src/api/consult.js`。
3.  **验证**：再次运行，确认气泡内容正确显示，且长文本末尾内容不丢失。

## 开放问题

- 暂无。这是非常明确的代码逻辑错误。

