# 前端API与后端对齐 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始设计 | 无 |
| 2026-01-17 | v1.1 | 补充页面渲染与 user 包裹结构问题分析 | 发现前端期望结构与后端返回不一致，补充风险与修正建议 |


## 研究问题

根据后端api文档，调整前端的api（src/api/auth.js），确保接口字段、方法、参数与 openapi.json 一致。扫描页面渲染，确保与后端返回结构对齐，尤其关注 user 包裹结构问题。


## 发现摘要

- 大部分页面通过 UserContext/useUser 获取用户数据，直接消费 user 对象，结构与后端 openapi.json UserOut 基本一致。
- 发现 src/store/UserContext.jsx 在 fetchUser 时默认从 res.user 取数据，实际后端直接返回 user 对象，导致 user 包裹结构不一致。
- 个人信息页、个人中心、首页等页面均直接消费 user，无 user: {...} 包裹假设。
- 建议以后端实际返回结构为准，修正 UserContext 相关实现。


## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/api/auth.js|前端鉴权与用户API封装|全文件|
|src/store/UserContext.jsx|用户上下文与全局 user 状态管理|全文件|
|src/store/useUser.js|用户钩子，页面消费 user|全文件|
|src/pages/my/PersonalInfo.jsx|个人信息页，渲染 user 及 profile|全文件|
|src/pages/my/index.jsx|个人中心页，渲染 user|全文件|
|src/pages/home/index.jsx|首页，渲染 user 及角色|全文件|
|openapi.json|后端API schema定义|全文件|


## 当前实现分析

- getCurrentUser()（src/api/auth.js）直接返回后端 user 对象（UserOut），无 user: {...} 包裹。
- UserContext.jsx fetchUser 处存在 const userData = res.user || null;，若后端无包裹则 userData 实际为 undefined，导致 user 状态异常。
- 页面层（PersonalInfo、MyPage、HomePage）均通过 useUser/useContext 直接消费 user，无包裹假设。
- 其他 API（register、updateUserProfile、login、logout）与后端 schema 对齐，无包裹问题。

### 核心流程

```
[getCurrentUser] -> fetch /api/auth/me -> (后端直接返回 UserOut) -> setUser(user)
[页面消费] -> useUser/useContext -> user 结构与后端一致
```

### 关键代码片段

- src/store/UserContext.jsx L37:
	```js
	const userData = res.user || null; // 应改为 const userData = res || null;
	```
- src/api/auth.js getCurrentUser:
	```js
	return await res.json(); // 直接返回 user 对象
	```
- 页面层：
	```js
	const { user } = useUser(); // 直接消费 user
	```

## 页面渲染与后端数据结构对齐分析

- 个人信息页（PersonalInfo.jsx）：直接消费 user、user.volunteer_profile、user.expert_profile，字段与后端一致。
- 个人中心页（index.jsx）：直接消费 user.avatar、user.nickname、user.roles。
- 首页（home/index.jsx）：通过 user.roles 控制卡片渲染，无包裹假设。
- 未发现页面层面依赖 user: {...} 包裹结构。


## 架构洞察

- 统一以后端实际返回结构为准，避免前端自定义包裹。
- UserContext fetchUser 处需修正，直接 setUser(res) 而非 res.user。
- 页面层消费 user 结构与后端一致，便于维护。


## 潜在风险和边缘情况

- 若 UserContext 未修正，生产环境下 user 可能为 null/undefined，导致页面渲染异常。
- MOCK_USER 结构需与后端 UserOut 保持同步，避免字段漂移。
- 若后端 schema 变更，需同步前端所有消费 user 的页面。


## 开放问题

- 是否有历史代码或第三方依赖仍假设 user: {...} 包裹？
- MOCK_USER 字段扩展如何自动校验与后端同步？
- 未来如需扩展 user 包裹结构，是否需统一前后端 schema？


## 参考资料

- docs/“心青年”智能体平台-数据模型与 API 设计.md
- openapi.json
- src/api/auth.js
- src/store/UserContext.jsx
- src/pages/my/PersonalInfo.jsx
- src/pages/my/index.jsx
- src/pages/home/index.jsx

