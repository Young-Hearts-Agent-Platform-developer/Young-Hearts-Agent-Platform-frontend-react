# 个人主页 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-13 | v1.0 | 初始设计 | 无 |

## 研究问题

- 个人主页（个人中心）页面的现有实现与架构分析。
- 如何在开发阶段设置一个具有最高权限的模拟用户数据。

## 发现摘要

- 个人主页页面已通过 `src/pages/my/index.jsx` 实现，依赖全局用户状态（Context）。
- 用户状态由 `UserContext` 提供，支持权限校验、登录、登出等。
- 权限控制粒度较细，支持多角色，且前端不持有 Token，安全性较高。
- 开发阶段可通过 mock `getCurrentUser` API 或直接在 `UserContext` 注入最高权限用户。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/pages/my/index.jsx|个人主页页面，展示用户信息|1-30|
|src/store/UserContext.jsx|全局用户状态与权限管理|1-60|
|src/store/useUser.js|useUser hook，简化 context 获取|1-20|
|src/api/auth.js|用户鉴权相关 API|—|
|docs/tasks/05-个人中心制作与部署/2026-01-13_通过context实现用户身份控制_研究报告.md|用户身份与权限 context 机制研究|1-60|
|docs/“心青年”智能体平台-前端界面设计方案.md|前端页面结构与风格设计|1-60|

## 当前实现分析

- 个人主页页面（`src/pages/my/index.jsx`）通过 `useUser` hook 获取用户信息与权限状态。
- 用户状态由 `UserContext` 提供，初始化时自动调用 `getCurrentUser`（API）获取后端用户信息。
- 权限校验通过 `checkPermission` 方法实现，支持多角色。
- 仅在个人中心页面展示用户详细信息，Header 组件为纯静态展示。
- 前端不持有 Token，所有鉴权依赖后端 HttpOnly Cookie。

### 核心流程

```
[App初始化] → [UserProvider挂载] → [调用getCurrentUser] → [后端校验Session] → [返回User信息] → [个人主页展示]
```

### 关键代码片段

#### 个人主页页面

```jsx
// src/pages/my/index.jsx
const { user, isAuthenticated, logout, loading } = useUser();
if (loading) return <div>加载中...</div>;
if (!isAuthenticated) return <div>未登录</div>;
return (
  <div>
    <h2>个人中心</h2>
    <div><strong>用户名：</strong>{user.username}</div>
    <div><strong>角色：</strong>{user.roles?.join(', ') || '无'}</div>
    <button onClick={logout}>退出登录</button>
  </div>
);
```

#### 用户状态管理

```jsx
// src/store/UserContext.jsx
const [user, setUser] = useState(null);
const fetchUser = useCallback(async () => {
  setLoading(true);
  try {
    const res = await getCurrentUser();
    setUser(res.user || null);
  } catch {
    setUser(null);
  } finally {
    setLoading(false);
  }
}, []);
```

## 架构洞察

- 权限与用户状态全局唯一，便于统一管理和扩展。
- 个人主页与权限校验解耦，便于后续扩展更多角色与展示内容。
- 前端不持有 Token，安全性高。
- 组件化设计，便于后续复用。

## 潜在风险和边缘情况

- 若后端 Session 失效，前端会自动登出，需保证用户体验。
- Mock 用户仅限开发环境，需防止误入生产。
- 角色权限变更需同步刷新 context。

## 开发阶段 Mock 最高权限用户建议

1. **方式一：Mock API**
   - 在 `src/api/auth.js` 的 `getCurrentUser` 方法中，开发环境直接返回最高权限用户对象：
   ```js
   // 仅开发环境
   export async function getCurrentUser() {
     return {
       user: {
         id: 1,
         username: 'dev-admin',
         roles: ['admin', 'superuser', 'expert'],
         email: 'dev@mock.com',
       }
     };
   }
   ```
2. **方式二：UserContext 注入**
   - 在 `UserContext.jsx` 的 `useEffect` 中，开发环境直接 setUser：
   ```js
   useEffect(() => {
     if (process.env.NODE_ENV === 'development') {
       setUser({
         id: 1,
         username: 'dev-admin',
         roles: ['admin', 'superuser', 'expert'],
         email: 'dev@mock.com',
       });
       setLoading(false);
     } else {
       fetchUser();
     }
   }, [fetchUser]);
   ```

## 开放问题

- 个人主页后续是否需要展示更多用户信息？
- 最高权限用户的角色定义是否需要统一？
- Mock 方案是否需支持切换不同角色？

## 参考资料

- [docs/tasks/05-个人中心制作与部署/2026-01-13_通过context实现用户身份控制_研究报告.md](../05-个人中心制作与部署/2026-01-13_通过context实现用户身份控制_研究报告.md)
- [docs/“心青年”智能体平台-前端界面设计方案.md](../../“心青年”智能体平台-前端界面设计方案.md)

