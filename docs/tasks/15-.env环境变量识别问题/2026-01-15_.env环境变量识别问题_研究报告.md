# .env 环境变量识别问题 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-15 | v1.0 | 初始设计 | 无 |

## 研究问题

为什么 .env 中配置的环境变量没有被 VITE 识别？

## 发现摘要

- Vite 只会注入以 `VITE_` 前缀命名的自定义环境变量，其他变量不会暴露给前端代码。
- `.env` 文件命名、变量命名、文件位置、Vite 启动方式等均会影响变量注入。
- 变量未被识别常见于命名不规范、缓存未刷新、文件未被正确加载等场景。
- 结合截图，存在 `VITE_MODE: "production"` 但 `MODE: "development"`，说明变量注入与 Vite 运行模式存在差异。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|.env|定义环境变量（如 VITE_API_BASE_URL）|L1|
|vite.config.js|Vite 构建与开发服务器配置|L1-L12|
|src/App.jsx|打印和使用环境变量的示例|L13-L28|
|package.json|依赖与脚本定义|L1-L40|

## 当前实现分析

### 现象描述

- 通过 `import.meta.env` 打印，发现部分自定义变量（如 `VITE_API_BASE_URL`）被识别，但 `VITE_MODE` 与 `MODE` 不一致。
- `MODE` 为 Vite 内置变量，反映实际运行模式（如 development/production）。
- `VITE_MODE` 为自定义变量，仅在 `.env` 文件中定义时才会出现。

### 变量注入机制

- 仅以 `VITE_` 开头的变量会被注入到前端代码。
- `.env` 文件需位于项目根目录，且命名需规范（如 `.env`, `.env.development`）。
- Vite 启动时会根据 `mode` 加载对应 `.env.[mode]` 文件。
- 变量变更后需重启 dev server，避免缓存影响。

### 关键代码/配置片段

- .env 示例：
  ```env
  VITE_API_BASE_URL=http://0.0.0.0:8000
  VITE_MODE=production
  ```
- src/App.jsx 示例：
  ```js
  useEffect(() => {
    console.log('📝 所有环境变量：', import.meta.env);
  }, []);
  ```
- vite.config.js 示例：
  ```js
  export default defineConfig({
    server: { host: '0.0.0.0', port: 5173 }
  })
  ```

## 架构洞察

- `MODE` 由 Vite 启动参数决定，不能通过 `.env` 文件直接覆盖。
- 自定义变量如 `VITE_MODE` 仅作普通字符串，不能影响 Vite 行为。
- 推荐仅通过 `import.meta.env.MODE` 判断环境，避免自定义 `VITE_MODE` 造成混淆。
- 变量变更后需重启 dev server，确保新变量生效。

## 潜在风险和边缘情况

- `.env` 文件命名或位置错误导致变量未被加载。
- 变量未加 `VITE_` 前缀无法被前端访问。
- 变量变更后未重启 dev server，导致旧值缓存。
- 生产环境未正确覆盖 `.env.production`，导致变量错乱。

## 开放问题

- 是否存在多个 `.env` 文件，优先级和加载顺序如何？
- 生产部署时如何保证变量正确覆盖？
- 是否有自动校验机制防止变量遗漏或命名错误？

## 参考资料

- [Vite 官方文档：环境变量与模式](https://cn.vitejs.dev/guide/env-and-mode.html)
- [Vite 配置参考](https://cn.vitejs.dev/config/)
- [前端环境变量最佳实践](https://juejin.cn/post/6844904197595338760)
