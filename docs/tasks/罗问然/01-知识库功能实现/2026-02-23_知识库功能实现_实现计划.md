# 知识库功能实现 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-02-23 | v1.0 | 初始计划 | 基于 2026-02-23 知识库功能实现研究报告制定 |
| 2026-02-23 | v1.1 | 增加自动化测试 | 响应用户需求，在各阶段补充自动化测试标准 |

## 关联研究
[2026-02-23_知识库功能实现_研究报告.md](docs/tasks/罗问然/01-知识库功能实现/2026-02-23_知识库功能实现_研究报告.md)

## 功能概述
本项目旨在实现“心青年”智能体平台的知识库模块，涵盖面向所有用户的知识浏览（大厅与详情）、面向志愿者/专家的知识贡献（含草稿与重编机制），以及面向专家/管理员的知识审核工作流。前端将采用模块化设计，独立封装 API 请求，并在页面级别实现严格的角色权限控制。

---

## Phase 1: 基础架构与 API 封装

### 目标
建立知识库模块的底层通信能力，并配置所有相关页面的路由，为后续页面开发提供基础骨架。

### 修改文件清单
| 文件路径 | 修改类型 | 说明 |
|---|---|---|
| `src/api/knowledge.js` | 新建 | 封装所有知识库相关的后端 API 请求 |
| `src/App.jsx` | 修改 | 引入并配置知识库及工作台相关的新路由 |

### 具体变更

**1. `src/api/knowledge.js`**
新建文件并导出 `knowledgeApi` 对象，包含以下方法：
- `getItems(params)`: `GET /api/knowledge/items`
- `getItemById(id)`: `GET /api/knowledge/items/${id}`
- `createItem(data)`: `POST /api/knowledge/items`
- `getAuditList(params)`: `GET /api/knowledge/audit-list`
- `auditItem(id, data)`: `POST /api/knowledge/${id}/audit`
- `uploadFile(formData)`: `POST /api/knowledge/upload` (需配置 `multipart/form-data` header)

**2. `src/App.jsx`**
- 使用 `React.lazy` 懒加载引入新页面组件：`KnowledgeDetailPage`, `ContributePage`, `ReviewPage`, `ReviewDetailPage`。
- 在 `<Routes>` 中增加对应的 `<Route>` 节点，路径分别为 `/knowledge/:id`, `/workspace/contribute`, `/workspace/review`, `/workspace/review/:id`。

**3. 自动化测试**
- 为 `src/api/knowledge.js` 编写单元测试（如使用 Jest/Vitest），Mock `apiClient` 验证各 API 方法的请求路径和参数是否正确。

### 成功标准
- [ ] `src/api/knowledge.js` 成功导出所有定义的 API 方法。
- [ ] 访问 `/knowledge/123` 或 `/workspace/contribute` 等新路由时，页面不白屏（即使组件暂时为空白占位）。
- [ ] API 单元测试覆盖率达到 80% 以上，且全部通过。

---

## Phase 2: C端浏览体验

### 目标
实现面向大众的知识库大厅和知识详情页，支持动态分类提取和 Markdown 富文本渲染。

### 修改文件清单
| 文件路径 | 修改类型 | 说明 |
|---|---|---|
| `src/pages/knowledge/index.jsx` | 修改 | 重构知识库大厅，实现列表展示与动态分类 |
| `src/pages/knowledge/components/KnowledgeCard.jsx` | 新建 | 知识库大厅专用的列表卡片组件 |
| `src/pages/knowledge/detail.jsx` | 新建 | 知识详情页，使用 `react-markdown` 渲染内容 |

### 具体变更

**1. `src/pages/knowledge/index.jsx`**
- 引入 `Header` 组件作为顶部导航。
- 在 `useEffect` 中调用 `knowledgeApi.getItems({ status: 'published' })` 获取数据。
- 遍历返回的数据列表，提取所有不重复的 `category` 字段，生成动态分类标签栏。
- 引入并使用新建的 `KnowledgeCard` 渲染列表项，点击跳转至 `/knowledge/:id`。

**2. `src/pages/knowledge/components/KnowledgeCard.jsx`**
- 接收 `item` 数据作为 props，展示标题、摘要、分类、作者及发布时间。
- 样式需符合移动端优先的响应式设计。

**3. `src/pages/knowledge/detail.jsx`**
- 引入 `Header` 组件（带返回按钮）。
- 从 URL 参数获取 `id`，调用 `knowledgeApi.getItemById(id)` 获取详情。
- 使用已安装的 `react-markdown` 渲染 `content` 字段。

**4. 自动化测试**
- 编写组件测试，验证 `KnowledgeCard` 是否正确渲染传入的 props。
- 编写集成测试，Mock `knowledgeApi.getItems`，验证知识库大厅能否正确渲染列表和动态分类标签。

### 成功标准
- [ ] 知识库大厅能正确展示已发布的知识列表，并能根据数据动态生成分类标签。
- [ ] 点击列表项可跳转至详情页，详情页能正确解析并渲染 Markdown 格式的正文。
- [ ] 组件测试和集成测试全部通过，能正确处理 API 返回空数据或异常的情况。

---

## Phase 3: 知识贡献与草稿机制

### 目标
实现知识贡献页面，支持表单填写、文件上传解析、本地草稿保存以及被驳回条目的重新编辑。

### 修改文件清单
| 文件路径 | 修改类型 | 说明 |
|---|---|---|
| `src/pages/workspace/contribute.jsx` | 新建 | 知识贡献表单页 |

### 具体变更

**1. `src/pages/workspace/contribute.jsx`**
- **权限拦截**：检查 `UserContext`，若非志愿者、专家或管理员，重定向至首页。
- **表单实现**：包含标题、分类、正文（Markdown 输入框）及文件上传组件。
- **草稿机制**：使用 `useEffect` 监听表单数据变化并存入 `localStorage`（如 key 为 `knowledge_draft`）。页面初始化时若检测到草稿则提示是否恢复。提交成功后清除草稿。
- **重编逻辑**：检查 URL 是否带有 `?id=xxx` 参数。若有，则调用 `knowledgeApi.getItemById(id)` 获取原数据填充表单（覆盖草稿逻辑），提交时调用更新接口（或按后端要求重新提交）。
- **文件上传**：调用 `knowledgeApi.uploadFile`，根据后端返回结果将解析后的文本追加到正文输入框中。

**2. 自动化测试**
- 编写集成测试，验证无权限角色的路由拦截逻辑。
- 编写组件测试，模拟用户输入，验证 `localStorage` 草稿的存取逻辑是否正确。
- Mock 文件上传 API，验证上传成功后文本是否正确追加到正文区域。

### 成功标准
- [ ] 无权限用户访问该页面被正确拦截。
- [ ] 输入内容后刷新页面，数据能从 LocalStorage 恢复。
- [ ] 携带 `id` 参数访问时，能正确回显被驳回的知识条目数据。
- [ ] 成功提交后，页面提示成功并跳转或清空表单。
- [ ] 权限拦截和草稿机制的自动化测试用例全部通过。

---

## Phase 4: 审核工作流与权限控制

### 目标
实现面向专家和管理员的知识审核列表及审核详情页，完成知识条目的闭环管理。

### 修改文件清单
| 文件路径 | 修改类型 | 说明 |
|---|---|---|
| `src/pages/workspace/review.jsx` | 新建 | 待审核知识列表页 |
| `src/pages/workspace/components/ReviewCard.jsx` | 新建 | 审核列表专用的卡片组件 |
| `src/pages/workspace/reviewDetail.jsx` | 新建 | 审核详情及操作页 |

### 具体变更

**1. `src/pages/workspace/review.jsx`**
- **权限拦截**：严格限制仅 `Expert` 和 `Admin` 角色可访问。
- 调用 `knowledgeApi.getAuditList()` 获取待审核列表。
- 使用新建的 `ReviewCard` 渲染列表，点击跳转至 `/workspace/review/:id`。

**2. `src/pages/workspace/components/ReviewCard.jsx`**
- 展示待审核条目的标题、提交人、提交时间及当前状态（如 `pending_review`）。

**3. `src/pages/workspace/reviewDetail.jsx`**
- **权限拦截**：同上。
- 获取详情并使用 `react-markdown` 渲染内容供审核者审阅。
- 底部提供“通过 (Pass)”和“驳回 (Reject)”按钮。
- 点击驳回时，弹窗要求输入驳回理由。
- 调用 `knowledgeApi.auditItem(id, { action, reason })` 提交审核结果，成功后返回审核列表。

**4. 自动化测试**
- 编写集成测试，验证仅 `Expert` 和 `Admin` 角色可渲染审核列表和详情页。
- 编写交互测试，验证点击“驳回”时是否正确弹出理由输入框，且未填写理由时无法提交。
- Mock `auditItem` API，验证通过/驳回操作的请求参数是否符合预期。

### 成功标准
- [ ] 仅专家和管理员可访问审核相关页面。
- [ ] 审核列表能正确展示待审核数据。
- [ ] 审核详情页能执行通过或驳回操作，驳回时必须填写理由，操作成功后状态正确流转。
- [ ] 审核工作流的权限控制和交互逻辑自动化测试全部通过。

---

## PR 就绪指南

**Commit Message 模板:**
```text
feat(knowledge): implement knowledge base core features

- Add knowledge API wrapper
- Implement knowledge hall and detail pages with markdown support
- Add contribute page with local draft and re-edit support
- Implement review workflow for experts/admins
```

**PR 描述要点:**
1. 概述实现了知识库的浏览、贡献和审核三大核心流程。
2. 强调在 `/workspace` 路由下实施了基于 `UserContext` 的严格权限拦截。
3. 说明了草稿保存机制（LocalStorage）和动态分类提取的实现方式。
4. 附带各关键页面的截图以便 Reviewer 快速验证 UI。