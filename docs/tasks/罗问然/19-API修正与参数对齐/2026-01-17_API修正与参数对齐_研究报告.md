# API修正与参数对齐 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始设计 | 对齐前端实现与 OpenAPI 文档 |

## 研究问题

如何参考 `openapi.json` 文档，修正目前项目中的 API 和相应的参数。

## 发现摘要

通过对比 `src/api/auth.js` 与 `openapi.json`，发现主要认证接口（登录、注册、获取当前用户、登出）的路径大致正确，但**更新用户信息**的接口路径错误。此外，前端 Mock 数据结构与 OpenAPI 定义的响应结构存在字段命名和包含关系的细微差异，需要进行标准化修正。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/api/auth.js|用户认证相关 API 实现|L17-L28 (updateUserProfile), L160 (login mock logic)|
|openapi.json|后端 API 定义文档|All|

## 当前实现分析

1.  **注册 (`register`)**:
    - 路径: `/api/auth/register` (匹配)
    - 参数: 代码注释声明严格对齐，需确保调用侧传递参数符合 `UserRegisterRequest`。

2.  **获取当前用户 (`getCurrentUser`)**:
    - 路径: `/api/auth/me` (匹配)
    - 方法: GET (匹配)

3.  **登录 (`login`)**:
    - 路径: `/api/auth/login` (匹配)
    - 方法: POST (匹配)
    - 问题: 代码中存在两段 Mock 逻辑判断 (L125 `if (import.meta.env.VITE_MODE...)` 和 L132 `if (isMock)`), 逻辑冗余且不一致。

4.  **登出 (`logout`)**:
    - 路径: `/api/auth/logout` (匹配)
    - 方法: POST (匹配)

5.  **更新用户信息 (`updateUserProfile`)**:
    - **路径错误**: 当前为 `/api/users/profile`，OpenAPI 定义应为 `PUT /api/auth/me`。
    - **参数问题**: OpenAPI 中 `UserUpdate` Schema 包含 `full_name`，但在 `UserOut` 中对应字段似乎是 `nickname`。需要确认后端 `UserUpdate` 的 `full_name` 是更新哪个字段，或者是 OpenAPI 定义的命名不一致。此外，OpenAPI 允许更新 `username`, `email`, `gender`, `password` 等。

6.  **Mock 数据 (`MOCK_USER`)**:
    - 存在字段不匹配情况。
    - `MOCK_USER` 包含 `bio` (OpenAPI 无), `expert_profile.organization` (OpenAPI 为 `org`), `expert_profile.specialties` (OpenAPI 可能用 `skills`).

## 架构洞察

- **API 路径统一**: 所有 `/auth` 相关操作应严格遵循 OpenAPI 路径。
- **Mock 数据类型安全**: Mock 数据应尽可能贴近真实后端返回结构，避免联调时出现字段 `undefined` 错误。
- **环境判断统一**: 统一使用 `import.meta.env.VITE_MODE` 或 `import.meta.env.MODE` 进行环境判断，避免混用。

## 潜在风险和边缘情况

- **字段名不一致**: 前端若依赖 `bio` 或 `specialties` 等字段展示信息，修正 Mock 数据后可能会导致页面部分内容缺失，需确认后端是否确实缺少这些字段或文档未更新。
- **UserUpdate Schema**: `UserUpdate` 结构比较扁平，没有嵌套 `volunteer_info` 或 `expert_info` 的更新字段。如果用户想更新专家简介，目前的 API 定义 (`PUT /api/auth/me`) 可能不支持，或者需要确认是否有其他专用接口 (如 `PATCH /api/experts/{id}` 等，但在本次 OpenAPI 片段中未展示)。

## 建议行动计划

1.  **修正 `updateUserProfile`**:
    - URL 变更为 `/api/auth/me`。
    - Method 确认为 `PUT`。
2.  **清理 `login` 函数**: 移除重复的 Mock 判断逻辑。
3.  **对齐 `MOCK_USER`**:
    - 将 `organization` 重命名为 `org` (如果依据 OpenAPI)。
    - 标记 `bio`, `qualifications` 等为 "前端独有/文档缺失"，需与后端确认。
4.  **生成 TypeScript 类型 (可选)**: 长期建议根据 OpenAPI 生成 `.d.ts` 文件以保证类型安全。

## 开放问题

- 后端 `PUT /api/auth/me` 是否支持更新 `volunteer_profile` 和 `expert_profile` 的内部字段？目前 `UserUpdate` schema 看上去不支持。
- `UserUpdate` 中的 `full_name` 是对应用户的真实姓名，还是昵称 (`nickname`)？`UserOut` 中有 `nickname` 但没有 root 级的 `full_name` (但在 profile 级有)。

## 参考资料

- [openapi.json](openapi.json)

