
# chat 页面 AI 对话流式联动 实现计划（重构版）

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-19 | v1.0 | 初始计划 | 基于 2026-01-19 研究报告 |
| 2026-01-19 | v2.0 | 标准对齐 Phase 3-4/6，重构计划 | 统一与智能体咨询页面实现标准 |
| 2026-01-19 | v2.1 | 拆分每个阶段为两个子阶段 | 便于逐步实现与验证 |

## 关联研究
[docs/tasks/罗问然/07-完善chat页面AI对话/2026-01-19_完善chat页面AI对话_研究报告.md](docs/tasks/罗问然/07-完善chat页面AI对话/2026-01-19_完善chat页面AI对话_研究报告.md)

## 功能概述
完善 chat 页面与后端联动的 AI 对话功能，实现基于 SSE（Server-Sent Events）的流式 AI 回复。AI 回复期间禁用“发送消息”按钮，支持异常弹窗、引用卡、快捷操作条，API 参数与返回结构严格对齐 openapi。

---


## Phase 1: SSE 工具类实现

### 目标
- 在 src/utils/sse.js 实现健壮的 SSE 工具类，支持事件监听、断开、错误捕获、连接状态管理。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/utils/sse.js|新增/补充|SSE 工具类，事件处理健壮|

### 具体变更
- 封装 EventSource 连接、消息拼接、异常处理、状态管理等。

### 成功标准
- 自动验证：SSE 工具类可被调用，事件流可被消费。
- 手动验证：断网/异常时能捕获并处理。

补充：已弃用此阶段，SSE 工具类实现已被移除，直接在 API 方法中集成 SSE 逻辑。

---

## Phase 2: chatSSE API 封装

### 目标
- 在 src/api/consult.js 封装基于 SSE 工具类的 chatSSE 方法，参数/返回结构严格对齐 openapi。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|补充/重构|chatSSE 方法封装，参数/返回结构对齐 openapi|

### 具体变更
- chatSSE 方法支持 onMessage、onError、onComplete 回调，参数/返回结构标准化。

### 成功标准
- 自动验证：chatSSE 可正常建立 SSE 连接。
- 手动验证：API 参数/返回结构与 openapi 一致。

---

## Phase 3: chat 页面集成 SSE

### 目标
- chat 页面集成 chatSSE，AI 回复流式分段追加到消息流。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/chat.jsx|补充/重构|集成 SSE，流式渲染|
|src/components/MessageList/index.jsx|补充|支持分段追加 AI 消息|

### 具体变更
- 发送消息时，AI 回复流式拼接展示。

### 成功标准
- 自动验证：AI 回复流式渲染。
- 手动验证：AI 回复期间消息可分段追加。

---

## Phase 4: 按钮禁用与异常弹窗

### 目标
- AI 回复期间禁用“发送消息”按钮，onComplete 后恢复。
- 遇 [ERROR] 时弹窗提示，断开连接。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/chat.jsx|补充/重构|按钮禁用、异常弹窗|
|src/pages/consultation/InputBar/index.jsx|补充|发送按钮禁用/恢复|
|src/components/Toast/|复用|异常弹窗组件|

### 具体变更
- AI 回复期间，发送按钮禁用，onComplete 后恢复。
- 遇 [ERROR] 时弹窗提示，断开连接。

### 成功标准
- 自动验证：异常弹窗可见。
- 手动验证：AI 回复期间按钮不可用，异常时弹窗提示。

---

## Phase 5: 引用卡组件实现

### 目标
- 支持 AI 回复中的引用卡（ReferenceCard），AI 消息含 sources 字段时渲染引用卡。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/ReferenceCard/index.jsx|新增|引用卡组件|
|src/pages/consultation/chat.jsx|补充|集成引用卡|

### 具体变更
- 引用卡点击跳转知识详情。

### 成功标准
- 自动验证：引用卡点击跳转 /knowledge/:id。
- 手动验证：引用卡可见。

---

## Phase 6: 快捷操作条组件实现

### 目标
- 支持 AI 回复中的快捷操作条（QuickActions），横向滚动，支持常用模板。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/QuickActions/index.jsx|新增|快捷操作条组件|
|src/pages/consultation/chat.jsx|补充|集成快捷操作条|

### 具体变更
- 快捷操作条横向滚动，支持常用模板。

### 成功标准
- 自动验证：快捷操作条可用。
- 手动验证：快捷操作条可见。

---

## Phase 7: API 方法完善

### 目标
- 封装 createSession、getSessions、getSessionMessages 等咨询相关 API 方法。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|补充|API方法完善|

### 具体变更
- 封装 createSession、getSessions、getSessionMessages 等 API。

### 成功标准
- 自动验证：API调用无报错。
- 手动验证：接口联调通过。

---

## Phase 8: chat 页面 API 调用对齐

### 目标
- chat 页面 API 调用与 openapi 结构严格对齐。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/chat.jsx|补充|API调用对齐|

### 具体变更
- chat 页面所有 API 调用参数/返回结构与 openapi 一致。

### 成功标准
- 自动验证：数据结构一致。
- 手动验证：接口联调通过。

---

## Commit message 模板

feat: chat 页面 AI 流式对话重构，标准对齐智能体咨询页面

- 支持基于 SSE 的 AI 回复流式推送
- AI 回复期间禁用发送按钮，异常弹窗
- 新增引用卡、快捷操作条组件
- API 参数与返回结构对齐 openapi

## PR 描述要点
- 说明 SSE 接口联动方式与异常处理
- 展示流式消息追加、按钮禁用、引用卡与快捷操作条效果
- 列出自动化与手动验证结果

