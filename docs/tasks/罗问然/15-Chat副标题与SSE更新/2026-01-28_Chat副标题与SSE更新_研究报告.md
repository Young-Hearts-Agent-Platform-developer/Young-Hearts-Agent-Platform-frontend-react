# Chat副标题与SSE更新 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-28 | v1.0 | 初始设计 | 无 |

## 研究问题

如何正确渲染 chat 页面的副标题，并正确地根据 SSE 协议中的 topic 更新副标题。

## 发现摘要

1.  **后端 SSE 协议支持**：后端通过 `event: topic` 推送会话标题更新，前端 API 层已正确解析。
2.  **API 层处理**：`src/api/consult.js` 中的 `chatSSE` 函数已包含对 `topic` 事件的处理逻辑，并通过 `onMessage` 回调的 `meta.isTopic` 标志传递给调用方。
3.  **UI 更新缺失**：`src/pages/consultation/chat.jsx` 组件使用本地 `subtitle` 状态控制显示。虽然在接收到 Topic 更新时调用了全局 Store 的 `setSessionTitle`，但**遗漏了更新本地 `subtitle` 状态**，导致页面副标题没有即时变化。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/pages/consultation/chat.jsx|Chat 页面主组件（处理消息发送与 SSE 回调）|L26, L145-147|
|src/api/consult.js|SSE API 封装（解析 event 流）|L98-L108|
|src/store/consultSession.jsx|会话全局状态管理|L42-L46|

## 当前实现分析

### SSE 解析逻辑 (src/api/consult.js)

`chatSSE` 函数流式读取响应，当检测到 `event: topic` 时，提取数据并触发回调。

```javascript
// src/api/consult.js L98
} else if (eventType === 'topic') {
  try {
    const obj = JSON.parse(data);
    if (typeof obj.topic === 'string') {
      // 关键点：将 topic 作为消息内容传递，并标记 isTopic
      onMessage(obj.topic, { isTopic: true });
    }
    // ...
```

### Chat 页面逻辑 (src/pages/consultation/chat.jsx)

页面使用本地 State `subtitle` 来渲染副标题，但在处理 SSE 回调时只更新了全局 Store。

```javascript
// src/pages/consultation/chat.jsx L26
const [subtitle, setSubtitle] = useState('新对话');

// ... L145 Handle Send Logic
await chatSSE(
  chatParams,
  {
    onMessage: (delta, meta) => {
      if (meta && meta.isTopic) {
        // 问题所在：只更新了全局 Store，未更新本地 UI State
        setSessionTitle(id, delta && delta.trim() ? delta : '新对话');
        // 缺失： setSubtitle(delta && delta.trim() ? delta : '新对话');
      } else if (meta && meta.isError) {
        // ...
      } else {
        // ... 处理普通消息流
      }
    },
    // ...
```

## 修复方案

在 `src/pages/consultation/chat.jsx` 的 `handleSend` 方法中，当检测到 `meta.isTopic` 时，同步更新本地 `subtitle` 状态。

```javascript
if (meta && meta.isTopic) {
  const newTitle = delta && delta.trim() ? delta : '新对话';
  setSessionTitle(id, newTitle); // 保持全局同步
  setSubtitle(newTitle);         // 新增：立即更新当前页面 UI
}
```

## 潜在风险

- **状态不一致**：如果 Store 更新失败（虽然是同步的，可能性极低）或者组件卸载后回调触发，可能会有 React 警告。建议检查 `useEffect` 的清理或组件挂载状态（现有代码看似已处理 `ignore` 标志，但 handleSend 闭包内未检查）。
- **初始加载**：目前 Chat 页面初始加载副标题是通过 `getSessions()` 全量拉取，性能较差，但这属于另一个优化课题。

## 开放问题

- 是否应该废弃 Chat 页面的本地 `subtitle` 状态，完全依赖 `useConsultSession` 中的 Store 数据？
  - **建议**：短期内保留本地状态以支持快速修复，且避免 Chat 页面强依赖 Store 中的全量 Session 列表（如果从未加载过列表直接进入 Chat 页，Store 可能是空的）。
