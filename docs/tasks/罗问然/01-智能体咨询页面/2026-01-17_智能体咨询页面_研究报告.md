# 智能体咨询页面 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始研究报告 | 新建 |
| 2026-01-17 | v1.1 | 补充历史会话入口设计 | 需求补充 |
| 2026-01-17 | v1.2 | 明确 SubLayout 作为页面模板及其定制能力分析 | 结构重构与一致性需求 |
| 2026-01-17 | v1.3 | 修正API接口描述，补充标准接口与调用示例 | 对齐API设计文档 |

## 研究问题

如何实现“智能体咨询”页面？（含流式输出、历史会话入口、API参数标准化、组件结构、异常处理等）



## 发现摘要

- 智能体咨询页面以沉浸式对话为核心，需支持流式消息输出（建议SSE/WebSocket）、引用卡片、快捷操作、一键转人工。
- 新增“历史会话”入口，便于用户回顾与管理过往咨询（当前仅占位，后续可扩展为会话列表与跳转）。
- 前端需实现消息流（MessageList）、输入区（InputBar）、引用卡（ReferenceCard）、快捷操作条（QuickActions）、历史会话入口（HistoryEntry）等组件，适配移动端优先。
- 流式输出需前后端协作，建议后端 `/api/consult/chat` 支持标准SSE/WebSocket协议，body需包含 session_id、content、role、reasoning_effort 等参数。
- 历史会话、消息详情、引用卡等均有标准API，需严格按API文档参数与返回结构实现，便于前后端解耦。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|docs/page-designs/智能体咨询-页面设计.md|页面设计规范与交互细节|全篇|
|docs/“心青年”智能体平台-功能文档.md|RAG咨询、工单、RBAC等后端能力说明|全篇|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|API标准定义与数据结构|全篇|
|src/pages/consultation/index.jsx|（假定）智能体咨询页面实现|待补充|
|src/components/MessageList/index.jsx|（假定）消息流组件|待补充|
|src/components/InputBar/index.jsx|（假定）输入区组件|待补充|
|src/components/HistoryEntry/index.jsx|（建议）历史会话入口组件（占位）|待补充|
|src/layouts/SubLayout.jsx|页面通用布局模板，包裹咨询主内容|全篇|

## 当前实现分析



### 1. 页面结构与核心流程（含 SubLayout 应用）


页面整体以 `SubLayout` 组件为顶层包裹，统一页面结构、导航与移动端适配。SubLayout 支持自定义 header、footer、内容区样式等，便于后续扩展和风格统一。

- SubLayout（页面模板）：统一头部、底部、内容区布局，支持 props 定制（如 title、showBack、extraActions、children 等）
  - 顶部 Header：通过 SubLayout 的 header slot 或 props 定制，包含返回、标题、转人工按钮、历史会话入口（占位，点击可跳转历史会话页，后续扩展）
- 会话区 MessageList：AI/用户气泡、时间、异常态、自动滚动
- 引用卡 ReferenceCard：AI消息下方，点击弹出详情
- 快捷操作条 QuickActions：常用模板横向滚动
- 输入区 InputBar：多行自适应、发送、附件/语音


#### 流程示意（含 SubLayout 包裹）：

```
用户进入页面 →
 1. 页面由 SubLayout 统一包裹，渲染 header（含返回、标题、历史会话入口、转人工等）
 2. 可见“历史会话”入口（占位，点击跳转/弹窗，后续实现）
 3. 用户输入问题 → 发送 →
   a. 前端展示用户气泡
   b. 前端请求后端（建议流式接口）
   c. AI回复流式输出，逐步渲染AI气泡
   d. 若有引用，渲染引用卡
   e. 用户可点击“转人工”，附带会话摘要跳转工单页
```



### 2. 关键API与调用示例（对齐API设计文档）

#### 2.1 会话与消息相关API


#### 2.1 会话与消息相关API（建议严格按API文档参数实现）
- 创建新会话
  - `POST /api/consult/sessions`（body: {topic, ...}，返回会话id等）
- 获取历史会话列表
  - `GET /api/consult/sessions`（返回 items: [{id, topic, created_at, ...}]）
- 获取会话消息详情
  - `GET /api/consult/sessions/:id`（返回 items: [{id, role, content, sources, created_at}]）
- 发送消息并获取AI回复（流式）
  - `POST /api/consult/chat`（body: {session_id, query, role, reasoning_effort}，建议SSE或WebSocket）

#### 2.2 关键前端调用示例


```js
// 发送消息并流式获取AI回复（标准API路径，建议SSE）
const response = await fetch('/api/consult/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ session_id, query, role, reasoning_effort })
});
const reader = response.body.getReader();
let aiMsg = '';
while(true) {
  const { done, value } = await reader.read();
  if (done) break;
  aiMsg += decode(value);
  setAiMessage(aiMsg); // 逐步渲染
}
```

```js
// 获取历史会话列表
const res = await fetch('/api/consult/sessions');
const { items, total } = await res.json();
// items: [{id, topic, created_at, ...}]
```

```js
// 获取会话消息详情
const res = await fetch(`/api/consult/sessions/${sessionId}`);
const { items } = await res.json();
// items: [{id, role, content, sources, created_at}]
```

```js
// 引用卡点击跳转知识详情
navigate(`/knowledge/${refId}`);
```

```js
// 转人工：跳转工单创建页，附带会话摘要
navigate('/my/tickets/create', { state: { summary: getSummary(messages) } });
```




## 架构洞察

- SubLayout 作为页面模板，统一了页面结构、导航与风格，便于后续维护和风格升级。
- SubLayout 支持灵活的 props 传递（如 title、header slot、extraActions），可满足不同页面的定制需求。

- 流式输出体验关键，建议优先采用 `/api/consult/chat`（SSE或WebSocket），body参数需包含 session_id、query、role、reasoning_effort。
- 消息、引用卡、历史会话等结构需标准化，严格按API文档参数与返回结构实现，便于前端渲染与跳转。
- “历史会话”入口建议独立组件，后续可扩展为会话列表、详情页。
- “转人工”需后端支持会话摘要生成，或前端本地生成摘要。
- 需注意移动端输入区与键盘适配、自动滚动。



## 潜在风险和边缘情况


- 后端接口若不支持 `/api/consult/chat` 流式输出（SSE/WebSocket），体验大幅下降。
- AI回复异常/超时需有兜底与重试机制，前端需监听流式异常并友好提示。
- 引用卡数据不全或知识详情404需友好提示。
- 转人工时摘要过长或敏感信息泄露风险。
- 历史会话入口如无数据源，需有占位与友好提示，后续数据结构需与主会话区解耦。
- 前端需严格按API文档参数与返回结构实现，避免字段不一致导致渲染异常。



## 开放问题


- `/api/consult/chat` 是否已支持SSE或WebSocket？流式协议细节、异常处理机制？
- 会话摘要生成由前端还是后端负责？摘要字段标准？
- 引用卡与知识详情的数据结构标准？（建议严格按API文档实现）
- 历史会话数据接口、结构、权限如何设计？是否支持分页、检索？

## 参考资料

- docs/page-designs/智能体咨询-页面设计.md
- docs/“心青年”智能体平台-功能文档.md
- docs/“心青年”智能体平台-数据模型与 API 设计.md
- OpenAI ChatGPT流式API、SSE/WebSocket最佳实践

