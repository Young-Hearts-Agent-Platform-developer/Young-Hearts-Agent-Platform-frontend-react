# 知识贡献逻辑修改 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-02-23 | v1.0 | 初始设计 | 响应用户需求，修改知识贡献功能的使用逻辑 |
| 2026-02-23 | v1.1 | 更新 API 规范 | 根据最新的 openapi.json 更新接口调用逻辑：使用 `GET /api/knowledge/my-items` 获取个人列表，统一使用 `POST /api/knowledge/upload` 创建条目 |

## 研究问题

参考实现计划的 Phase 3和附件2的api规范，修改“知识贡献”功能的使用逻辑：
1. 从首页点击卡片，先进入个人的知识贡献历史，按照最新更改的时间顺序，呈现该用户提交的各条知识贡献。
2. 通过右上角的“+”进行新的知识贡献。下面的按钮除了“取消”、“提交审核”外，中间要加上一个“存为草稿”。相应地调整status参数。
3. 点击某条知识贡献，可跳转到对应的知识贡献界面（与2的见界面一致）。

## 发现摘要

1. **路由与页面结构调整**：需要新增一个“个人知识贡献历史”页面（如 `src/pages/workspace/contributeHistory.jsx`），作为首页卡片的跳转目标。原有的知识贡献表单页（`src/pages/workspace/contribute.jsx`）需调整路由路径（如 `/workspace/contribute/edit`）。
2. **表单页按钮与状态调整**：现有的 `ContributePage` 底部按钮需调整为“取消”、“存为草稿”、“提交审核”。提交时，需根据点击的按钮类型，向后端传递不同的 `status` 参数（`draft` 或 `pending_review`）。
3. **API 适配**：
    - **获取列表**：使用新接口 `GET /api/knowledge/my-items` 获取当前用户的知识贡献列表。
    - **创建条目**：`POST /api/knowledge/items` 已删除。无论纯文本还是文件，统一使用 `POST /api/knowledge/upload` 接口创建新条目。
    - **更新条目**：使用 `PUT /api/knowledge/items/{id}` 更新现有条目（草稿或被驳回的条目），该接口也支持更新 `status`。

## 相关文件清单

| 文件路径 | 作用说明 | 关键行号 |
|---|---|---|
| [src/pages/home/index.jsx](src/pages/home/index.jsx) | 首页卡片跳转逻辑 | [L35-L40](src/pages/home/index.jsx#L35-L40) |
| [src/App.jsx](src/App.jsx) | 路由配置 | [L35-L40](src/App.jsx#L35-L40) |
| [src/pages/workspace/contribute.jsx](src/pages/workspace/contribute.jsx) | 知识贡献表单页 | [L400-L430](src/pages/workspace/contribute.jsx#L400-L430) |
| [src/api/knowledge.js](src/api/knowledge.js) | 知识库 API 封装 | [L50-L140](src/api/knowledge.js#L50-L140) |
| `src/pages/workspace/contributeHistory.jsx` | (需新建) 个人知识贡献历史列表页 | - |

## 当前实现分析

目前，首页的“知识贡献”卡片直接跳转到 `/workspace/contribute`，即知识贡献表单页。
表单页底部只有“取消”和“提交”两个按钮。提交时，区分了文件上传和纯文本创建，分别调用了不同的 API。
新的 API 规范要求所有创建操作统一走 upload 接口，且支持状态控制。

### 核心流程

1. **首页跳转**：用户点击首页“知识贡献”卡片 -> 跳转至 `/workspace/contribute` (需改为历史列表页)。
2. **历史列表页**：调用 `knowledgeApi.getMyItems()` -> 渲染列表 -> 点击右上角“+”跳转至 `/workspace/contribute/edit` -> 点击列表项跳转至 `/workspace/contribute/edit?id=xxx`。
3. **表单页**：用户填写表单 -> 点击“存为草稿” -> 提交数据，`status` 为 `draft` -> 返回列表页。
4. **表单页**：用户填写表单 -> 点击“提交审核” -> 提交数据，`status` 为 `pending_review` -> 返回列表页。

### 关键代码片段

**需要修改的 API 调用逻辑**:
```javascript
// src/api/knowledge.js

// 新增获取个人列表
getMyItems: async (params = {}) => { /* GET /api/knowledge/my-items */ },

// 修改创建逻辑，统一使用 upload
uploadFile: async (formData) => { /* POST /api/knowledge/upload */ },
// createItem 方法应被移除或通过 uploadFile 实现
```

**表单提交逻辑 ([src/pages/workspace/contribute.jsx](src/pages/workspace/contribute.jsx#L150-L180))**:
需要根据是否有 `editId` 决定调用 `uploadFile` (创建) 还是 `updateItem` (更新)。
无论哪种情况，都需要传递 `status` 参数。

如果是**新建** (无 editId):
```javascript
const formDataObj = new FormData();
// ... append title, category, etc.
if (selectedFile) {
  formDataObj.append('file', selectedFile);
} else {
  // 纯文本也走 upload
  formDataObj.append('text_content', formData.content); 
}
formDataObj.append('status', isDraft ? 'draft' : 'pending_review');
await knowledgeApi.uploadFile(formDataObj);
```

如果是**更新** (有 editId):
```javascript
// PUT /api/knowledge/items/{id} 是 JSON body
const updateData = {
  ...formData,
  status: isDraft ? 'draft' : 'pending_review'
};
// 注意：如果更新时要替换文件，目前 PUT 接口似乎只接受 JSON，可能无法直接替换文件？
// 检查 openapi.json，PUT 接口 Bodies 是 application/json，schema 是 KnowledgeItemUpdate。
// KnowledgeItemUpdate 中包含 file_path 但不包含 binary file。
// 这意味着：如果需要修改文件，可能需要特殊处理（例如删除重建，或者后端扩展 PUT 支持）。
// 假设目前更新主要针对元数据和文本内容。如果涉及文件变更，可能需要提示用户重新创建或后端补充接口。
// 暂时假设更新仅更新文本/元数据。
await knowledgeApi.updateItem(editId, updateData);
```

## 架构洞察

- **API 变化**：`POST /api/knowledge/items` 被删除，这大大简化了前端逻辑，所有新建操作统一为 "上传"（无论是传文件还是传文本）。
- **个人列表**：新增了 `GET /api/knowledge/my-items`，专门服务于“我的贡献”列表，解决了之前关于如何筛选个人数据的疑问。

## 潜在风险和边缘情况

- **更新带文件的条目**：当前的 `PUT /api/knowledge/items/{item_id}` 定义为 JSON 格式，这意味着它不支持 `multipart/form-data`。如果用户想在“重编”时替换上传的文件，目前的 API 无法直接支持。
  - *临时方案*：在前端限制，并在编辑模式下，如果原条目是基于文件的，不允许修改文件（或提示需删除重传）。
  - *长期方案*：后端 `PUT` 接口支持 Multipart，或提供单独的 `PUT /file` 接口。
  采用临时方案。

- **纯文本上传**：`upload` 接口要求 `text_content` 字段。前端在提交纯文本时，需将 markdown 内容放入 `text_content` 字段。

## 开放问题

- 确认 `PUT /api/knowledge/items/{item_id}` 确实不支持文件替换？（根据 openapi.json，确实只接受 JSON）。前端将在编辑页禁用文件选择器的修改功能，仅允许修改元数据和 `status`。

确定。
