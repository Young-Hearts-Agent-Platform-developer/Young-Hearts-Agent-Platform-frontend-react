# 历史消息加载与 chat 联动 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-19 | v1.0 | 初始计划 | 基于研究报告与澄清问题 |

## 关联研究
[docs/tasks/罗问然/06-历史消息加载与chat联动/2026-01-19_历史消息加载与chat联动_研究报告.md](docs/tasks/罗问然/06-历史消息加载与chat联动/2026-01-19_历史消息加载与chat联动_研究报告.md)

## 功能概述
实现从历史会话（history）页面跳转至 chat 页面时，自动加载并渲染对应 sessionId 的历史消息，消息 API 严格对齐 openapi.json，消息列表统一渲染。

**注意：后端返回的会话唯一标识字段为 `id`，而非 `sessionid`，所有参数传递、API 调用、前端状态管理等均应以 `id` 字段为准，避免混淆。**

---

## Phase 1: 历史消息 API 封装与对齐

### 目标
- 在 src/api/consult.js 中实现/完善获取历史消息的 API 方法，接口参数与返回结构严格对齐 openapi.json。
- **特别强调：API 参数与返回结构均以 `id` 字段为主，禁止使用 `sessionid` 作为字段名。**

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|更新|新增 getSessionMessages 或类似方法，参数为 sessionId|
|openapi.json|只读|对照接口规范|

### 具体变更
- 新增/完善获取历史消息的 API 方法，参数为会话 id（即后端返回的 id 字段），返回消息数组。
- 方法命名建议：getSessionMessages(id)

### 成功标准
- 自动验证：调用新方法能正确获取指定 id 的历史消息，返回结构与 openapi.json 一致。
- 手动验证：可用 mock id 在控制台输出历史消息。

---

## Phase 2: chat 页面参数接收与历史消息加载

### 目标
- chat.jsx 支持通过路由参数接收 id（会话唯一标识），并在初始化时自动加载历史消息，合并本地消息流。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/chat.jsx|更新|useParams 获取 id，useEffect 拉取历史消息|

### 具体变更
- 使用 useParams 获取 id（会话唯一标识，来源于后端返回的 id 字段）。
- useEffect 监听 id 变化，调用 getSessionMessages 加载历史消息。
- setMessages 初始化为历史消息，后续发送消息追加。

### 成功标准
- 自动验证：页面加载后 messages 状态包含历史消息。
- 手动验证：通过 history 跳转 chat，历史消息自动展示。

---

## Phase 3: history 跳转参数传递

### 目标
- 确保 history.jsx 跳转 chat 页面时通过路由参数传递 id（会话唯一标识）。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/history.jsx|更新|跳转 chat 时附带 id 参数|

### 具体变更
- 跳转 chat 页面时，使用 navigate(`/consultation/chat/${id}`) 或等效写法，id 来源于后端返回的会话 id 字段。

### 成功标准
- 自动验证：跳转后 chat 页面能获取到 id。
- 手动验证：从 history 页面点击进入 chat，URL 包含 id，chat 页面正常加载。

---

## Phase 4: MessageList 兼容历史消息渲染

### 目标
- MessageList 组件无需区分历史与新消息，统一渲染消息数组。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/MessageList/index.jsx|检查/微调|确保 messages prop 支持历史+新消息混合渲染|

### 具体变更
- 检查 MessageList 组件，确保 messages prop 为数组即可，无需特殊处理。

### 成功标准
- 自动验证：传入历史+新消息数组，组件正常渲染。
- 手动验证：chat 页面历史与新消息无缝展示。

---

## 验证步骤
1. 启动前端，进入 history 页面，选择任一会话跳转 chat。
2. chat 页面自动加载并展示历史消息。
3. 发送新消息，历史与新消息顺序正确。
4. 控制台无接口/渲染报错。

---

## Commit message 模板
feat: 支持 chat 页面历史消息加载与联动

## PR 描述要点
- 严格对齐 openapi.json，新增历史消息 API 封装
- chat 页面支持 sessionId 参数并自动加载历史消息
- history 跳转参数传递与 MessageList 统一渲染

