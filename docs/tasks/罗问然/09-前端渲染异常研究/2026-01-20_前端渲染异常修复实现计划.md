# 前端渲染异常修复实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-20 | v1.0 | 初始计划 | 基于异常研究报告与澄清结论 |

## 关联研究
[docs/tasks/罗问然/09-前端渲染异常研究/2026-01-20_前端渲染异常研究报告.md](docs/tasks/罗问然/09-前端渲染异常研究/2026-01-20_前端渲染异常研究报告.md)

## 功能概述
修复咨询页面因SSE流buffer处理不当导致的空白气泡问题，兼容历史与新消息格式，保留消息原始换行，优化前端渲染体验。

---

## Phase 1: 修复SSE buffer丢失（致命缺陷）

### 目标
确保SSE流结束时，buffer中残留内容能被正确处理并渲染，兼容所有消息格式。

### 修改文件清单

|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|更新|while循环后补充buffer处理逻辑|

### 具体变更
- 在SSE流读取循环结束后，判断buffer是否有内容，若有则调用onMessage处理。
- 提取单行处理逻辑为函数，循环内外复用。

### 成功标准
- 自动验证：本地模拟无换行符/末尾无换行符的SSE响应，消息内容完整渲染。
- 手动验证：页面无空白气泡，所有历史与新消息均正常显示。

---

## Phase 2: 优化换行符处理与样式

### 目标
保留消息原始换行，前端正确显示多段落和空行。

### 修改文件清单

|文件路径|修改类型|说明|
|---|---|---|
|src/api/consult.js|更新|调整split/拼接逻辑，保留换行|
|src/pages/consultation/chat.jsx|更新|确保渲染时不丢失换行|
|相关组件样式文件|更新|气泡样式添加white-space: pre-wrap|

### 具体变更
- 修改消息分帧逻辑，保留原始换行符。
- chat气泡内容渲染时使用pre-wrap样式。

### 成功标准
- 自动验证：多段落消息、空行消息均能正确显示。
- 手动验证：换行、空行在UI中与原始内容一致。

---

## Phase 3: 验证与回归测试

### 目标
复现、修复、验证，确保无新回归。

### 修改文件清单

|文件路径|修改类型|说明|
|---|---|---|
|无自动化测试|手动|需手动Mock接口或实际操作验证|

### 具体变更
- 手动构造各类消息场景，逐一验证修复效果。

### 成功标准
- 手动验证：所有历史与新消息格式均无渲染异常，换行、空行、长文本均正常。

---

## Commit message 模板

```
fix: 修复SSE流buffer丢失导致的空白气泡及换行渲染异常

- 修复SSE流结束时buffer未处理导致的消息丢失
- 优化换行符处理，保留原始消息格式
- 气泡样式支持pre-wrap，兼容多段落与空行
```

## PR描述要点

- 详述致命缺陷与修复点
- 说明兼容历史与新消息格式
- 列出手动验证场景与结果
