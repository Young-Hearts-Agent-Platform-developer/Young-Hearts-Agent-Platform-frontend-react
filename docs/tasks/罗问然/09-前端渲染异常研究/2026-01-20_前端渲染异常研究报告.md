# 前端渲染异常研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-20 | v1.0 | 初始研究报告 | 新建任务 |

## 研究问题

参考附件，后端给出了正确的响应，但前端没有正确渲染。

## 发现摘要

- 后端返回内容已包含 query、role 字段，响应结构合理。
- 前端 `chat.jsx` 已实现消息流渲染，但仅当消息内容结构与预期一致时才会正确显示。
- 若后端返回内容格式与前端 `MessageList` 组件或 `messages` 状态结构不符，可能导致渲染异常或内容丢失。
- 当前 `handleSend` 及历史消息拉取逻辑均依赖 `setMessages`，但未对消息内容做结构校验。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/pages/consultation/chat.jsx|智能体咨询主页面，消息流渲染与交互|L1-L149|
|src/pages/consultation/MessageList.jsx|单条消息渲染组件|—|
|src/api/consult.js|API 请求实现，含 chatSSE、getSessionMessages|—|

## 当前实现分析

### 核心流程

1. 页面加载时通过 `getSessionMessages(id)` 拉取历史消息，结果赋值给 `messages`。
2. 用户发送消息时，`handleSend` 先将用户消息和空 AI 消息插入 `messages`，随后调用 `chatSSE` 进行流式 AI 回复。
3. `chatSSE` 的 `onMessage` 回调不断追加 AI 回复内容，实时更新最后一条 AI 消息。
4. 渲染时，`messages.map` 逐条渲染，每条消息交由 `MessageList` 组件处理。
5. 若 AI 消息含 `sources` 或 `quickActions` 字段，则分别渲染引用卡片和快捷操作条。

### 关键代码片段

- 消息流状态与渲染：
  - `const [messages, setMessages] = useState([]);`  ([chat.jsx] L20)
  - `messages.map((msg, idx) => (<MessageList messages={[msg]} /> ... ))` ([chat.jsx] L110-L112)
- AI 回复流式追加：
  - `onMessage: (delta, meta) => { ... setMessages ... }` ([chat.jsx] L74-L76)
- 历史消息拉取：
  - `getSessionMessages(id).then(res => { ... setMessages(res) ... })` ([chat.jsx] L34-L39)

## 架构洞察

- 前端假定每条消息结构需包含 `role`、`content` 字段，AI 消息可选 `sources`、`quickActions`。
- 若后端返回结构与前端不一致（如缺少 `content` 或嵌套层级不同），会导致渲染异常或内容缺失。
- `MessageList` 组件对消息内容的健壮性依赖较高，建议增加结构校验与容错。

## 潜在风险和边缘情况

- 后端返回的消息对象字段缺失或类型不符，前端未做兼容处理。
- AI 回复内容为空或格式异常时，页面无提示或渲染空白。
- `setMessages` 直接赋值时未做深拷贝或结构转换，可能导致历史消息与新消息混用出错。

## 开放问题

- `MessageList` 组件对消息结构的具体要求为何？（如必须字段、可选字段）
- 是否有后端返回嵌套结构或特殊字段未被前端识别？
- 是否需要在前端增加消息结构的校验与降级渲染？

## 参考资料

- [chat.jsx](../../../src/pages/consultation/chat.jsx)
- [MessageList.jsx](../../../src/pages/consultation/MessageList.jsx)
- [API接口文档](../../../docs/“心青年”智能体平台-数据模型与 API 设计.md)

