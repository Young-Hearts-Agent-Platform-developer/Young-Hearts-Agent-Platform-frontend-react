# 会话命名与流式输出 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-21 | v1.0 | 初始计划 | 基于 2026-01-20 研究报告及补充澄清 |

## 关联研究
[docs/tasks/罗问然/10-会话命名与流式输出/2026-01-20_会话命名与流式输出_研究报告.md](docs/tasks/罗问然/10-会话命名与流式输出/2026-01-20_会话命名与流式输出_研究报告.md)

## 功能概述
实现会话命名自动化与流式输出体验优化：
- 前端能根据后端 SSE 流中的 [TOPIC] 包自动更新会话标题。
- 支持流式消息逐段/逐字渲染，提升交互体验。
- 增加 topic 为 null 的兜底机制，避免会话标题异常。

---

## Phase 1: session store 支持单条 title 更新

### 目标
为 consultSession.jsx 增加 setSessionTitle 方法，支持按 sessionId/title 更新，便于后续流式 topic 分发。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/store/consultSession.jsx|更新|新增 setSessionTitle 方法|

### 具体变更
- 在 consultSession.jsx 导出 setSessionTitle 方法，接收 sessionId 和新 title，直接更新对应 session 的 title 字段。
- 若 title 为 null 或空，兜底为“新对话”或其他默认值。

### 成功标准
- 自动验证：调用 setSessionTitle 后，sessions 中对应项 title 立即变更。
- 手动验证：控制台调用 setSessionTitle，SessionList UI 实时刷新。

---

## Phase 2: chat.jsx 处理 [TOPIC] 并分发到 session store

### 目标
chat.jsx 的 onMessage 回调识别 meta.isTopic 时，调用 setSessionTitle 实现自动命名。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/chat.jsx|更新|onMessage 处理 meta.isTopic，调用 setSessionTitle|
|src/api/consult.js|查阅/微调|确保 [TOPIC] 识别与回调逻辑无误|

### 具体变更
- onMessage: 若 meta.isTopic，调用 setSessionTitle，参数为当前 sessionId 和 delta（topic 内容）。
- 若 delta 为空或 null，兜底为“新对话”。
- 保证 [TOPIC] 包被完整识别。

### 成功标准
- 自动验证：后端推送 [TOPIC] 后，SessionList title 自动变更。
- 手动验证：模拟 [TOPIC] 包，UI title 实时刷新。

---

## Phase 3: SessionList 响应 title 变更自动刷新

### 目标
确保 SessionList 依赖 sessions 响应式，title 变更后 UI 自动刷新。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/SessionList/index.jsx|查阅/微调|确保 title 依赖 sessions 响应式|

### 具体变更
- 检查 SessionList 是否通过 props.sessions 传递，确保 title 变更后自动刷新。
- 如有必要，优化 useEffect/useStore 依赖。

### 成功标准
- 自动验证：sessions title 变更后，SessionList UI 自动同步。
- 手动验证：多窗口/多端同步测试。

---

## Phase 4: 流式输出体验优化

### 目标
优化 setMessages 粒度与渲染节奏，实现更平滑的逐段/逐字流式体验。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/consultation/MessageList/index.jsx|更新|优化流式渲染逻辑|
|src/pages/consultation/chat.jsx|更新|setMessages 调用节奏优化|

### 具体变更
- 优化 setMessages 调用频率，避免整体刷新，提升流畅度。
- 可采用 requestAnimationFrame 或分段累加策略。
- 保证流式消息每次推送都能即时渲染。

### 成功标准
- 自动验证：自动化测试流式推送，UI 渲染无明显卡顿。
- 手动验证：实际体验逐字/逐段输出流畅。

---

## 兜底机制：topic 为 null 处理
- setSessionTitle 内部如遇 topic 为空/null，title 兜底为“新对话”或其他默认文案。
- chat.jsx onMessage 处理 [TOPIC] 时同步兜底。

---

## Commit message 模板
feat: 会话命名与流式输出优化，支持 [TOPIC] 自动命名与流式渲染

## PR 描述要点
- 支持 SSE [TOPIC] 自动驱动会话命名
- 新增 setSessionTitle，支持单条 title 更新
- 优化流式消息渲染体验
- 增加 topic 为空的兜底机制

