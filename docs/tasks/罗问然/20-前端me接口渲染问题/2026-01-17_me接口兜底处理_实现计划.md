# 前端 me 接口兜底处理 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始实现计划 | 依据研究报告与需求制定兜底方案 |

## 背景

根据《me接口渲染问题 研究报告》，前端页面高度依赖 me 接口返回的 user 对象结构。roles、avatar、nickname 字段为 null 或空时，页面会降级为“未登录”或显示默认内容，影响用户体验。为提升健壮性与一致性，需在前端实现兜底处理。

## 目标

- roles 字段：必须为非空数组，否则页面降级为“未登录”或“无角色”。
- avatar 字段：若为空，自动使用默认头像。
- nickname 字段：若为空，自动赋值为 username。
- 保证 user 对象结构完整，提升页面渲染健壮性。

## 兜底处理方案

1. 在 user 注入（setUser）前，统一处理 roles、avatar、nickname 字段：
   - roles：若为 null 或空数组，直接 setUser(null) 或标记为未登录。
   - avatar：若为 null/空字符串，赋值为默认头像（如 userAvatar）。
   - nickname：若为 null/空字符串，赋值为 username。
2. 兜底逻辑建议集中在 src/store/UserContext.jsx 的 fetchUser 或 setUser 逻辑中，避免多处重复判断。
3. 页面消费 user 时，无需再判断 nickname/avatar/roles 的空值，提升代码简洁性。

## 涉及文件

|文件路径|作用说明|关键行号|
|---|---|---|
|src/store/UserContext.jsx|用户上下文，建议在 setUser 前兜底处理|L1-L80|
|src/api/auth.js|getCurrentUser/me接口实现|L1-L186|
|src/pages/my/index.jsx|个人中心主页面，消费 user|L1-L107|
|src/pages/my/PersonalInfo.jsx|个人信息详情页，消费 user|L1-L289|

## 推荐实现步骤

1. 在 src/store/UserContext.jsx 的 fetchUser 或 setUser 逻辑中，增加如下兜底处理：
   ```js
   function normalizeUser(rawUser) {
     if (!rawUser || !Array.isArray(rawUser.roles) || rawUser.roles.length === 0) return null;
     return {
       ...rawUser,
       avatar: rawUser.avatar || userAvatar, // userAvatar为默认头像
       nickname: rawUser.nickname || rawUser.username,
     };
   }
   // ...
   setUser(normalizeUser(res.user));
   ```
2. 保证所有页面通过 useUser/useContext 获取的 user 均为兜底后的结构。
3. 可在开发环境下模拟 roles 为空、avatar/nickname 为空等场景进行验证。

## 风险与注意事项

- roles 字段兜底为 null 时，需确保页面降级逻辑一致（如直接 setUser(null)）。
- avatar/nickname 兜底后，页面不再需要多处判空，注意同步清理冗余判断。
- 若后端字段类型变更，需同步调整 normalizeUser 逻辑。

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始实现计划 | 依据研究报告与需求制定兜底方案 |

## 参考资料
- docs/tasks/罗问然/20-前端me接口渲染问题/2026-01-17_me接口渲染问题_研究报告.md
- src/types/User.d.ts
- src/store/UserContext.jsx
