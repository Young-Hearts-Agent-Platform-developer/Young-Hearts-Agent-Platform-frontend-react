
# 个人信息角色字段显示问题 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-15 | v2.0 | 彻底重构，聚焦 roles 字段判断与 user 对象扩展字段挂载 | 适配后端/Mock 结构与前端渲染逻辑 |
| 2026-01-15 | v1.0 | 初始设计 | 无 |

## 研究问题

“个人信息”页面如何依据 roles 字段，正确渲染“志愿者”、“专家”扩展字段，并确保与后端/Mock 返回结构一致。

## 发现摘要

- 后端接口与 Mock 数据返回结构已统一，扩展信息（volunteer_profile、expert_profile）直接挂载于 user 对象。
- 页面渲染逻辑仅依赖 user.roles 是否包含 volunteer/expert，且仅在 user 对象存在对应扩展字段时渲染。
- 只要 roles 字段包含 volunteer/expert 且 user 对象有 volunteer_profile/expert_profile 字段，即可正确渲染扩展信息。
- 多角色用户（如同时为志愿者和专家）可同时渲染多组扩展字段。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/pages/my/PersonalInfo.jsx|个人信息页面主逻辑，分组渲染扩展字段|L61-L137|
|src/store/UserContext.jsx|用户上下文，拉取和存储用户信息|L1-L60|
|src/api/auth.js|用户信息接口与Mock数据|L1-L120|
|src/utils/roleMapping.js|角色中英文映射|L17-L31|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|数据模型定义|L1-L60|

## 当前实现分析

### 1. 页面分组渲染逻辑
- 通过 `user.roles` 判断是否为志愿者/专家：
  - `const isVolunteer = rolesArr.includes('volunteer');`
  - `const isExpert = rolesArr.includes('expert');`
- 若 `isVolunteer && user.volunteer_profile`，则渲染志愿者分组；若 `isExpert && user.expert_profile`，则渲染专家分组。
- 多角色用户可同时渲染多组扩展字段。
- 详见 [src/pages/my/PersonalInfo.jsx](src/pages/my/PersonalInfo.jsx#L108-L137)

### 2. 用户上下文与数据来源
- `UserContext` 通过 `getCurrentUser` 拉取用户信息，user 对象结构如下：
```js
{
  ...user,
  roles: ['volunteer', 'expert'],
  volunteer_profile: { ... },
  expert_profile: { ... }
}
```
- 后端/Mock 层已保证扩展字段直接挂载于 user 对象。
- 详见 [src/api/auth.js](src/api/auth.js#L61-L120)

### 3. 字段命名与渲染适配
- 页面渲染依赖 user.volunteer_profile、user.expert_profile 字段，命名与后端/Mock 保持一致。
- roles 字段为唯一判断依据，扩展字段是否渲染仅取决于 roles 是否包含 volunteer/expert。

#### 核心流程（伪代码）

```js
if (user.roles.includes('volunteer') && user.volunteer_profile) {
  // 显示志愿者扩展字段
}
if (user.roles.includes('expert') && user.expert_profile) {
  // 显示专家扩展字段
}
```

## 关键代码片段

**src/pages/my/PersonalInfo.jsx**

```js
const rolesArr = Array.isArray(user.roles) ? user.roles : [];
const isVolunteer = rolesArr.includes('volunteer');
const isExpert = rolesArr.includes('expert');
// ...
{isVolunteer && user.volunteer_profile && (
  <SectionContainer title="志愿者信息">{/* ... */}</SectionContainer>
)}
{isExpert && user.expert_profile && (
  <SectionContainer title="专家信息">{/* ... */}</SectionContainer>
)}
```

**src/api/auth.js**（Mock/接口返回结构示例）

```js
{
  user: {
    id: 1,
    roles: ['volunteer', 'expert'],
    volunteer_profile: { ... },
    expert_profile: { ... }
  }
}
```

## 架构洞察

- roles 字段为扩展信息渲染的唯一入口，便于后续角色扩展。
- user 对象扩展字段命名与后端/Mock 保持一致，降低前后端适配成本。
- 多角色用户可灵活支持多组扩展字段渲染。

## 潜在风险和边缘情况

- 若后端返回结构变动（如字段名变更或嵌套层级调整），前端需同步适配。
- roles 字段与扩展字段内容不一致时（如 roles 包含 volunteer 但无 volunteer_profile），页面不会渲染该分组。
- 需关注未来新增角色的扩展字段命名规范。

## 开放问题

- 后端接口 roles 字段与扩展字段的标准命名是否有文档约定？
- 多角色用户的真实用例是否已覆盖所有边界场景？
- 未来如有新角色，扩展字段命名是否有统一规范？

## 参考资料

- [src/pages/my/PersonalInfo.jsx](src/pages/my/PersonalInfo.jsx)
- [src/api/auth.js](src/api/auth.js)
- [docs/“心青年”智能体平台-数据模型与 API 设计.md](docs/“心青年”智能体平台-数据模型与 API 设计.md)

