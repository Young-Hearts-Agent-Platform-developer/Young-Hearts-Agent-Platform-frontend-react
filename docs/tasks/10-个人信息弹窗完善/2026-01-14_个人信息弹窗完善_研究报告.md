# 个人信息弹窗完善 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-14 | v1.0 | 初始研究报告 | 新建任务与研究 |

## 研究问题

完善“个人信息”页面的弹窗，要求：
- 可编辑字段点击弹窗，表单控件类型按字段类型自动渲染：
    - 自由输入字段（如昵称、邮箱）：Input 输入框。
    - 固定选项字段（如性别、服务状态、是否公开）：单选控件（美化为滑动选择/Segmented/Switch）。
    - 邮箱字段：暂用输入框，代码中预留邮箱验证接口（如 sendEmailVerification），UI 可加注释。
- 目前的实现有问题，无法正确显示按钮。

## 发现摘要

- 字段类型与控件映射已基本实现，支持 input、segmented、switch 三类。
- 弹窗按钮无法正确显示，**根因是 antd-mobile Modal 组件 5.x 版本 API 已变更，原 confirmText/cancelText/onConfirm/onCancel 等 props 已废弃，需用 actions 数组配置按钮。**
- 邮箱字段已预留验证接口注释，未实现实际验证。
- 字段分组与动态渲染结构清晰，便于扩展。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|src/pages/my/PersonalInfo.jsx|个人信息页面主逻辑，弹窗与表单控件渲染|L1-L234|
|src/components/ListMenu/index.jsx|字段列表渲染组件|（未详细分析）|
|src/api/auth.js|用户信息更新接口|（未详细分析）|

## 当前实现分析

### 字段与控件映射
- 字段配置（baseFields/volunteerFields/expertFields）中通过 type 指定控件类型（input/segmented/switch）。
- renderEditInput() 根据 editField.type 渲染对应控件：
    - input → <Input />
    - segmented → <Segmented />
    - switch → <Switch />

### 弹窗渲染与按钮
- 使用 antd-mobile 的 <Modal /> 组件，props 传递 confirmText/cancelText/onConfirm/onCancel（如下代码片段）。
- 但**在 antd-mobile 5.x 版本（当前 package.json 为 ^5.42.3）下，这些 props 已被废弃，不会生效，按钮区不会渲染**。
- 正确做法是使用 actions 数组配置按钮，详见下方“根因分析与迁移建议”。
- 若 editField 为空，弹窗不显示。
- loading 状态下禁用关闭。

### 邮箱字段
- 字段配置中 public_email 带 verify: true 注释，代码中有“预留邮箱验证接口”注释。
- 实际 UI 仅为 Input 输入框，未实现邮箱验证与发送逻辑。

### 关键代码片段

#### 字段配置与控件类型
src/pages/my/PersonalInfo.jsx L11-L58
```js
const baseFields = [
  { key: 'nickname', label: '昵称', editable: true, type: 'input' },
  { key: 'gender', label: '性别', editable: true, type: 'segmented', options: [...] },
  { key: 'public_email', label: '公开邮箱', editable: true, type: 'input', verify: true }, // 预留邮箱验证接口
  ...
];
```

#### 弹窗渲染
src/pages/my/PersonalInfo.jsx L210-L234
```js
// 旧写法（无效，按钮不显示）
<Modal
  visible={!!editField}
  content={renderEditInput()}
  title={editField?.label}
  closeOnMaskClick={!loading}
  onClose={() => !loading && setEditField(null)}
  confirmText="确认"
  cancelText="取消"
  onCancel={() => !loading && setEditField(null)}
  onConfirm={handleSave}
  confirmLoading={loading}
  ...
/>

// 正确写法（antd-mobile 5.x 官方推荐）
<Modal
  visible={!!editField}
  content={renderEditInput()}
  title={editField?.label}
  closeOnMaskClick={!loading}
  onClose={() => !loading && setEditField(null)}
  actions={[
    { key: 'cancel', text: '取消', onClick: () => !loading && setEditField(null) },
    { key: 'confirm', text: '确认', bold: true, onClick: handleSave, disabled: loading }
  ]}
  ...
/>
```

#### 控件渲染逻辑
src/pages/my/PersonalInfo.jsx L159-L186
```js
const renderEditInput = () => {
  if (!editField) return null;
  if (editField.type === 'input') {
    return <Input ... />;
  }
  if (editField.type === 'segmented' && editField.options) {
    return <Segmented ... />;
  }
  if (editField.type === 'switch') {
    return <Switch ... />;
  }
  return null;
};
```

## 架构洞察
- 字段配置与控件类型解耦，便于扩展和维护。
- 弹窗与表单控件渲染逻辑清晰，支持多类型字段。
- 邮箱验证功能可通过 verify 字段扩展。
- antd-mobile Modal 组件升级需关注 API 变更，actions 数组是 5.x 及以后唯一支持的按钮配置方式。

## 潜在风险和边缘情况
- Modal 组件属性变更或 antd-mobile 版本兼容性可能导致按钮不显示。
- 若未来 antd-mobile 再次升级 Modal API，需及时查阅官方文档，避免按钮丢失。
- 字段类型未覆盖时控件渲染为 null，需兜底处理。
- 邮箱验证未实现，用户体验不完整。

## 开放问题
- 弹窗按钮无法显示，**已确认为 Modal 组件 5.x API 变更导致，需用 actions 数组配置按钮。**
- 邮箱验证接口（如 sendEmailVerification）如何集成？
- 其他字段类型（如多选、日期等）如何扩展？

## 参考资料
- [antd-mobile Modal 文档](https://mobile.ant.design/zh/components/modal)
- [antd-mobile Modal 5.x 变更说明](https://mobile.ant.design/zh/components/modal#%E6%8C%89%E9%92%AE%E5%8C%BA%E9%85%8D%E7%BD%AE)
- 项目 docs/“心青年”智能体平台-前端界面设计方案.md
