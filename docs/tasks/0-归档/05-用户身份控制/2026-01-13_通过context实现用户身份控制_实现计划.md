# 通过 context 实现用户身份控制 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-13 | v1.0 | 初始计划 | 基于 v1.2 研究报告 |

## 关联研究
[docs/tasks/05-个人中心制作与部署/2026-01-13_通过context实现用户身份控制_研究报告.md](docs/tasks/05-个人中心制作与部署/2026-01-13_通过context实现用户身份控制_研究报告.md)

## 功能概述
本计划旨在为“心青年”智能体平台前端实现基于 React Context 的全局用户身份与权限管理，满足如下需求：
- 采用 HttpOnly Cookie 方案，前端不持有 Token。
- 用户信息与权限集中管理，仅个人中心页面展示。
- Card 组件支持权限粒度控制。
- Header 组件彻底静态化。

---

## Phase 1: 用户身份全局 Context 构建

### 目标
实现 `UserContext`，支持全局用户信息、权限、登录/登出、权限校验等能力。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/store/UserContext.jsx|新增|核心 Context 及 Provider、useUser hook|
|src/api/auth.js|新增|鉴权相关 API 封装|

### 具体变更
- 新建 `UserContext.jsx`，实现 Provider、useUser、checkPermission、login、logout 等。
- 新建 `auth.js`，实现 getCurrentUser、login、logout API，所有请求自动携带 Cookie。

### 成功标准
- 自动验证：
  - `UserProvider` 挂载后自动拉取用户信息。
  - `useUser` 能获取 user、isAuthenticated、checkPermission 等。
- 手动验证：
  - 断开后端 Session，前端自动登出。
  - 登录/登出流程无 Token 暴露。

---

## Phase 2: 权限感知 Card 组件改造

### 目标
Card 组件支持 requiredRole 属性，按权限渲染/隐藏。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/components/Card/index.jsx|更新|接入 useUser，支持 requiredRole 权限判断|
|src/components/Card/README.md|更新|补充权限用法说明|

### 具体变更
- Card 组件引入 useUser，渲染前判断权限。
- 无权限时返回 null 或占位符。
- 文档补充 requiredRole 用法。

### 成功标准
- 自动验证：
  - 单元测试/Storybook 展示不同权限下的渲染效果。
- 手动验证：
  - 切换用户角色，Card 显示/隐藏符合预期。

---

## Phase 3: 个人中心页面接入与展示

### 目标
个人中心页面展示用户信息，仅在 /my 路径下渲染。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/pages/my/index.jsx|新增|个人中心主页，展示用户信息、登出按钮等|
|src/layouts/HomeLayout.jsx|更新|在顶层包裹 UserProvider|

### 具体变更
- 新建 my/index.jsx，展示 user 信息、支持登出。
- HomeLayout 顶层包裹 UserProvider，确保全局可用。

### 成功标准
- 自动验证：
  - 访问 /my 时能正确展示用户信息。
- 手动验证：
  - 仅 /my 页面有用户信息展示，其他页面无泄露。

---

## Phase 4: Header 组件静态化

### 目标
Header 组件彻底静态化，不再订阅用户状态。

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|src/components/Header/index.jsx|更新|移除所有与用户相关的逻辑|
|src/components/Header/README.md|更新|说明 Header 仅静态展示|

### 具体变更
- 移除 useUser/useContext 等所有身份相关代码。
- 文档补充静态说明。

### 成功标准
- 自动验证：
  - Header 组件无任何用户信息渲染。
- 手动验证：
  - 登录/登出后 Header 不发生变化。

---

## PR 提交模板

**commit message**：
feat: 基于 context 实现用户身份全局管理与权限控制

**PR 描述要点**：
- 新增 UserContext，实现全局用户与权限管理
- Card 组件支持 requiredRole 权限控制
- 个人中心页面接入用户信息展示
- Header 组件静态化，移除身份逻辑

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-13 | v1.0 | 初始计划 | 基于 v1.2 研究报告 |
